<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Data collection - 4&nbsp; Data cleaning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./02_data_workflow.html" rel="prev">
<link href="./../figures/favicon.png" rel="icon" type="image/png">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-dark.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="site_libs/bootstrap/bootstrap-dark.min.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./03_data_curation.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data cleaning</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Data collection</a> 
        <div class="sidebar-tools-main tools-wide">
    <a href="https://github.com/biostats-r/biostats" rel="" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
    <div class="dropdown">
      <a href="" title="Share" id="quarto-navigation-tool-dropdown-0" class="quarto-navigation-tool dropdown-toggle px-1" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Share"><i class="bi bi-share"></i></a>
      <ul class="dropdown-menu" aria-labelledby="quarto-navigation-tool-dropdown-0">
<li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://twitter.com/intent/tweet?url=%7Curl%7C">
              <i class="bi bi-bi-twitter pe-1"></i>
            Twitter
            </a>
          </li>
          <li>
            <a class="dropdown-item sidebar-tools-main-item" href="https://www.facebook.com/sharer/sharer.php?u=%7Curl%7C">
              <i class="bi bi-bi-facebook pe-1"></i>
            Facebook
            </a>
          </li>
      </ul>
</div>
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01_design-spreadsheets.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Design spreadsheets</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_data_workflow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data workflow</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_data_curation.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data cleaning</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar"><div class="quarto-margin-header"><div class="margin-header-item">
<p><a href="https://biostats.w.uib.no/"><img src="https://biostats.w.uib.no/files/2020/01/biostats-button-res2.png" title="bioST@TS | When biology adds up, at last…" class="img-fluid"></a> <br><a href="../index.html"><img src="../figures/icons_all.png" title="BioST@TS books" width="250" height="50"></a></p>
</div></div>
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#useful-packages" id="toc-useful-packages" class="nav-link active" data-scroll-target="#useful-packages"><span class="header-section-number">4.1</span> Useful packages</a></li>
  <li><a href="#import-data" id="toc-import-data" class="nav-link" data-scroll-target="#import-data"><span class="header-section-number">4.2</span> Import data</a></li>
  <li><a href="#view-dataset" id="toc-view-dataset" class="nav-link" data-scroll-target="#view-dataset"><span class="header-section-number">4.3</span> View dataset</a></li>
  <li><a href="#check-variable-type" id="toc-check-variable-type" class="nav-link" data-scroll-target="#check-variable-type"><span class="header-section-number">4.4</span> Check variable type</a></li>
  <li><a href="#check-for-duplicates" id="toc-check-for-duplicates" class="nav-link" data-scroll-target="#check-for-duplicates"><span class="header-section-number">4.5</span> Check for duplicates</a></li>
  <li><a href="#check-for-missing-data" id="toc-check-for-missing-data" class="nav-link" data-scroll-target="#check-for-missing-data"><span class="header-section-number">4.6</span> Check for missing data</a></li>
  <li>
<a href="#check-range-of-values" id="toc-check-range-of-values" class="nav-link" data-scroll-target="#check-range-of-values"><span class="header-section-number">4.7</span> Check range of values</a>
  <ul class="collapse">
<li><a href="#categorical-variables" id="toc-categorical-variables" class="nav-link" data-scroll-target="#categorical-variables"><span class="header-section-number">4.7.1</span> Categorical variables</a></li>
  <li><a href="#numeric-variables" id="toc-numeric-variables" class="nav-link" data-scroll-target="#numeric-variables"><span class="header-section-number">4.7.2</span> Numeric variables</a></li>
  </ul>
</li>
  <li>
<a href="#check-taxonomy" id="toc-check-taxonomy" class="nav-link" data-scroll-target="#check-taxonomy"><span class="header-section-number">4.8</span> Check taxonomy</a>
  <ul class="collapse">
<li><a href="#use-case_when" id="toc-use-case_when" class="nav-link" data-scroll-target="#use-case_when"><span class="header-section-number">4.8.1</span> Use case_when()</a></li>
  <li><a href="#use-taxon-dictionary" id="toc-use-taxon-dictionary" class="nav-link" data-scroll-target="#use-taxon-dictionary"><span class="header-section-number">4.8.2</span> Use taxon dictionary</a></li>
  <li><a href="#checking-taxon-using-tnrs" id="toc-checking-taxon-using-tnrs" class="nav-link" data-scroll-target="#checking-taxon-using-tnrs"><span class="header-section-number">4.8.3</span> Checking Taxon using TNRS</a></li>
  </ul>
</li>
  <li>
<a href="#visualise-data" id="toc-visualise-data" class="nav-link" data-scroll-target="#visualise-data"><span class="header-section-number">4.9</span> Visualise data</a>
  <ul class="collapse">
<li><a href="#histogram-or-density-plot" id="toc-histogram-or-density-plot" class="nav-link" data-scroll-target="#histogram-or-density-plot"><span class="header-section-number">4.9.1</span> Histogram or density plot</a></li>
  <li><a href="#correlations" id="toc-correlations" class="nav-link" data-scroll-target="#correlations"><span class="header-section-number">4.9.2</span> Correlations</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title"><span id="sec-data-cleaning" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Data cleaning</span></span></h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i></button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header><p>Data cleaning is the first steps after digitizing the data. Each dataset has to be checked for several types of errors and corrected if possible. Some of the checking and correction can be done automatically, but other things have to be done manually. And sometimes we need play detectives to find the problems and the right way to correct errors. This tutorial shows the main steps for how to check a dataset and make corrections.</p>
<p>For this tutorial we will be working with the trait dataset from Svalbard. See chapter <span class="quarto-unresolved-ref">?sec-pftc-data</span> for how to access the data and information about the study, experiment and datasets.</p>
<section id="useful-packages" class="level2" data-number="4.1"><h2 data-number="4.1" class="anchored" data-anchor-id="useful-packages">
<span class="header-section-number">4.1</span> Useful packages</h2>
<p>There are a couple of R packages that are useful for data curation. First, <strong>tidyverse</strong> is a collection of R packages used for basic data manipulation and analysis. We will also use <strong>lubridate</strong>, which helps with data and time formats.</p>
<p>If you have never used the packages you need to install it first using the function <code>install.packages("tidyverse")</code>. Otherwise, you can just load the packages.</p>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Another useful package for data curation is <strong>tidylog</strong>, which is built on the <strong>dplyr</strong> and <strong>tidyr</strong> packages and provides useful information about the functions used.</p>
<p>Tidylog will for example tell you how many rows have been removed and are remaining when using the <code>filter()</code> function or how many rows match when using a join function. The information is always indicated in absolute numbers and percentage. This additional information is very useful to check if the right observations have been removed or manipulated, because mistakes are easily done.</p>
<p>Let’s install and/or load <strong>tidylog</strong>.</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/elbersb/tidylog/">tidylog</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note, that once <strong>tidylog</strong> is loaded it will automatically prioritize the tidylog function before the dplyr and tidyr functions. You actively have to choose if you do not want to use the tidylog version by using this notation: <code><a href="https://dplyr.tidyverse.org/reference/filter.html">dplyr::filter()</a></code>.</p>
<p>Some data checking has to be done by hand and detecitve work, other things can be done more automatically. There are a few packages that can help with some of this work and for this tutorial we will use the <code>validate</code> package.</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#install.packages("validate")</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/data-cleaning/validate">validate</a></span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="import-data" class="level2" data-number="4.2"><h2 data-number="4.2" class="anchored" data-anchor-id="import-data">
<span class="header-section-number">4.2</span> Import data</h2>
<p>The first step is to import the dataset to R. The data is stored as a <em>csv file</em> and we can use the function <code><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv()</a></code> to import that data. If your data has another format or you are new to importing data, have a look at this <a href="https://biostats-r.github.io/biostats/workingInR/importing-data-in-r.html">page</a>.</p>
<p>Give the dataset a name using a backwards pointing arrow: <code>&lt;-</code> The name should indicate that this is the raw data.</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/PFTC4_Svalbard_2018_Gradient_Traits.csv"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Rows: 11345 Columns: 15</span></span>
<span><span class="co">#&gt; ── Column specification ────────────────────────────────────────────────────────</span></span>
<span><span class="co">#&gt; Delimiter: ","</span></span>
<span><span class="co">#&gt; chr  (7): Project, Gradient, PlotID, ID, Functional_group, Taxon, Trait</span></span>
<span><span class="co">#&gt; dbl  (7): Year, Site, Individual_nr, Value, Elevation_m, Latitude_N, Longitu...</span></span>
<span><span class="co">#&gt; date (1): Date</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ℹ Use `spec()` to retrieve the full column specification for this data.</span></span>
<span><span class="co">#&gt; ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The dataset has 11345 rows and 15 columns and a number of numeric, character and date variables. It contains measurements of 14 traits from two elevational gradients on Svalbard. The traits were measured on individual plants from 21 different graminoid and forb species. For more information about the sites, traits and measurements see <a href="https://github.com/Plant-Functional-Trait-Course/PFTC_4_Svalbard">here</a>.</p>
<p><strong>Some manipulation</strong></p>
<p>Let us introduce some errors to the dataset.</p>
<p>The code to do this is hidden. But if you want to replicate the code to introduce errors you can find the code from <a href="https://github.com/Plant-Functional-Trait-Course/PFTC_teaching_material/blob/main/quarto_webpage/8_data_curation.qmd">line 116</a>.</p>
</section><section id="view-dataset" class="level2" data-number="4.3"><h2 data-number="4.3" class="anchored" data-anchor-id="view-dataset">
<span class="header-section-number">4.3</span> View dataset</h2>
<p>First, we want to have a look at the dataset. By typing <code>raw_traits</code> in the console it will display the first rows and columns of the dataset. Note that the last column and many rows are not shown.</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span></span>
<span><span class="co">#&gt; # A tibble: 10,298 × 10</span></span>
<span><span class="co">#&gt;    Date       Gradient  Site PlotID Individual_nr ID      Taxon    Trait   Value</span></span>
<span><span class="co">#&gt;    &lt;chr&gt;      &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;    &lt;chr&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 2018-07-20 B            5 D                  1 AIB1395 saxifra… Plan… 6.5 e+0</span></span>
<span><span class="co">#&gt;  2 2018-07-20 B            5 D                  1 AIB1395 saxifra… Wet_… 2.92e-2</span></span>
<span><span class="co">#&gt;  3 2018-07-20 B            5 D                  1 AIB1395 saxifra… Dry_… 4   e-3</span></span>
<span><span class="co">#&gt;  4 2018-07-20 B            5 D                  1 AIB1395 saxifra… Leaf… 5.66e-1</span></span>
<span><span class="co">#&gt;  5 2018-07-20 B            5 D                  1 AIB1395 saxifra… Leaf… 6.75e-1</span></span>
<span><span class="co">#&gt;  6 2018-07-20 B            5 D                  1 AIB1395 saxifra… SLA_… 1.69e+2</span></span>
<span><span class="co">#&gt;  7 2018-07-20 B            5 D                  1 AIB1395 saxifra… LDMC  1.37e-1</span></span>
<span><span class="co">#&gt;  8 2018-07-20 B            5 D                  1 AIB1395 saxifra… C_pe… 3.89e+1</span></span>
<span><span class="co">#&gt;  9 2018-07-20 B            5 D                  1 AIB1395 saxifra… N_pe… 1.14e+0</span></span>
<span><span class="co">#&gt; 10 2018-07-20 B            5 D                  1 AIB1395 saxifra… CN_r… 3.41e+1</span></span>
<span><span class="co">#&gt; # ℹ 10,288 more rows</span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: Elevation_m &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>At the top you can see that the dataset has 10298 observations and 10 columns. These numbers give you a first indication if you have imported the right dataset, and if all observations and columns are there.</p>
</section><section id="check-variable-type" class="level2" data-number="4.4"><h2 data-number="4.4" class="anchored" data-anchor-id="check-variable-type">
<span class="header-section-number">4.4</span> Check variable type</h2>
<p>One of the things we want to do is checking if all the variables in the dataset have the right type. For each variable the output above indicates the data type just below the variable name. The most common types are <em>dbl</em> (numeric or integer), <em>chr</em> (character), or <em>date</em> (date).</p>
<p>If you are unfamiliar with data types see <a href="https://biostats-r.github.io/biostats/workingInR/first-steps-in-r.html#data-types-and-objects">here</a>.</p>
<p>The first variable <em>Date</em> is a character, which does not seem to be correct. This means that one or several observations in this column are not dates. Since we do not expect to have very many dates (the data was collected during a few days), we can check all the different values in <em>Date</em>. For this we use the function <code>distinct()</code> on the variable <em>Date</em>.</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">Date</span><span class="op">)</span></span>
<span><span class="co">#&gt; distinct: removed 10,291 rows (&gt;99%), 7 rows remaining</span></span>
<span><span class="co">#&gt; # A tibble: 7 × 1</span></span>
<span><span class="co">#&gt;   Date      </span></span>
<span><span class="co">#&gt;   &lt;chr&gt;     </span></span>
<span><span class="co">#&gt; 1 2018-07-20</span></span>
<span><span class="co">#&gt; 2 2018-07-18</span></span>
<span><span class="co">#&gt; 3 2018-07-21</span></span>
<span><span class="co">#&gt; 4 2018-07-19</span></span>
<span><span class="co">#&gt; 5 2018-07-17</span></span>
<span><span class="co">#&gt; 6 18        </span></span>
<span><span class="co">#&gt; 7 &lt;NA&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that there are 6 distinct dates in the variable <em>Date</em>. One of the dates is “18”, which is not a correct date format and turned the variable into a character. Note the additional information from the tidylog package on the <code>distinct()</code> function, which shows the number of rows removed and remaining.</p>
<p>The next step is to check which observastion(s) have the wrong date. For this we can use the function <code>filter()</code> to extract all observations with the date 18. We can pipe this to <code><a href="https://rdrr.io/r/utils/View.html">View()</a></code>, which will display the whole table in a separate window. Note that for this tutorial, we use a different way of displaying the output</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">Date</span> <span class="op">==</span> <span class="st">"18"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/View.html">View</a></span><span class="op">(</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<pre><code>#&gt; filter: removed 10,291 rows (&gt;99%), 7 rows remaining
#&gt; # A tibble: 7 × 10
#&gt;   Date  Gradient  Site PlotID Individual_nr ID      Taxon         Trait    Value
#&gt;   &lt;chr&gt; &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;         &lt;chr&gt;    &lt;dbl&gt;
#&gt; 1 18    C            1 A                  3 AMO3822 salix polaris Plant… 1.1 e+0
#&gt; 2 18    C            1 A                  3 AMO3822 salix polaris Wet_M… 5.76e-3
#&gt; 3 18    C            1 A                  3 AMO3822 salix polaris Dry_M… 2   e-3
#&gt; 4 18    C            1 A                  3 AMO3822 salix polaris Leaf_… 1.88e-1
#&gt; 5 18    C            1 A                  3 AMO3822 salix polaris Leaf_… 2.84e-1
#&gt; 6 18    C            1 A                  3 AMO3822 salix polaris SLA_c… 1.42e+2
#&gt; 7 18    C            1 A                  3 AMO3822 salix polaris LDMC   3.47e-1
#&gt; # ℹ 1 more variable: Elevation_m &lt;dbl&gt;</code></pre>
</div>
<p>We can see that a single observation (with multiple traits) has the wrong date. There is no way that we would remember on what day this leaf was collected (remember the dataset has &gt; 10000 leaves!). We have to start playing detectives now. The only way to find the right date for these observations is to check the raw data (leaves), notes or photos. It is therefore important to keep all the data entry sheets (paper version), take a photo of them and make tidy notes during field work. This is the only way to fix many of the problems.</p>
<p>Luckily, we took pictures from all envelopes of the leaves. The date on the envelope is <em>18 July 2018</em> (<a href="#fig-envelope">Figure&nbsp;<span>4.1</span></a>), and it seems that there has been a typo.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-envelope" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="./pics/envelope.png" class="img-fluid figure-img" alt="A photo showing the envelope of the leaf with the wrong date." width="492"></p>
<figcaption class="figure-caption">Figure&nbsp;4.1: The envelope of the leaf with the wrong date.</figcaption></figure>
</div>
</div>
</div>
<p>Let’s replace the wrong date and give the variable <em>Date</em> the right class.</p>
<p>For this we will use the function <code>mutate()</code> which adds or manipulates a column. Inside the mutate we will use the <code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> function to replace the date for a specific ID. This function is useful for a single condition. However for multiple statements (many if else conditions), we recommend to use the <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> function (see below). To change the class, we use the <code><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd()</a></code> function from the lubridate package. Note that we now have to assign the table to a new or the same name to make the change permanent.</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="st">"AMO3822"</span>, <span class="st">"2018-07-18"</span>, <span class="va">Date</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Date <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; mutate: changed 7 values (&lt;1%) of 'Date' (0 new NAs)</span></span>
<span><span class="co">#&gt; mutate: converted 'Date' from character to Date (0 new NA)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>An important step and good practice when cleaning data is to check that the right correction has been done. Here is where the <strong>tidylog</strong> package comes in handy. It shows that for 7 observation Date has been changed. This matches with the number of observations that had a wrong date.</p>
<p>To be absolutely sure we can look at the specific leaf (ID == “AMO3822”) and see if the date is now corrected. Another way would be to run the <code>distinct(Date)</code> function again.</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="st">"AMO3822"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="va">Date</span><span class="op">)</span></span>
<span><span class="co">#&gt; filter: removed 10,291 rows (&gt;99%), 7 rows remaining</span></span>
<span><span class="co">#&gt; select: dropped 9 variables (Gradient, Site, PlotID, Individual_nr, ID, …)</span></span>
<span><span class="co">#&gt; # A tibble: 7 × 1</span></span>
<span><span class="co">#&gt;   Date      </span></span>
<span><span class="co">#&gt;   &lt;date&gt;    </span></span>
<span><span class="co">#&gt; 1 2018-07-18</span></span>
<span><span class="co">#&gt; 2 2018-07-18</span></span>
<span><span class="co">#&gt; 3 2018-07-18</span></span>
<span><span class="co">#&gt; 4 2018-07-18</span></span>
<span><span class="co">#&gt; 5 2018-07-18</span></span>
<span><span class="co">#&gt; 6 2018-07-18</span></span>
<span><span class="co">#&gt; 7 2018-07-18</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The date has been fixed.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 1
</div>
</div>
<div class="callout-body-container callout-body">
<p>Now it is your turn. Check if the data type for the variable <em>Date</em> is now correct.</p>
<details><summary><p>Hint</p>
</summary><ul>
<li>type <code>raw_traits</code> to look at the whole dataset where the datatype of each variable is indicated</li>
<li>use <code>class(raw_traits$Date)</code> which will tell you directly what type of class the variable has</li>
<li>use <code>map(raw_traits, class)</code> to get the class of all variable in the dataframe</li>
</ul></details>
</div>
</div>
<p>Using the <code>validate</code> package, we can check all the variables at once. The validate package is based on making some rules that need checking and then applying those rules to a dataset. The rules can be reused and applied to any dataset.</p>
<p>Let’s make some rules about data types using the <code><a href="https://rdrr.io/pkg/validate/man/validator.html">validator()</a></code> function:</p>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># rules</span></span>
<span><span class="va">rules</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/validate/man/validator.html">validator</a></span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="co"># check variable types</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">Gradient</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">PlotID</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">ID</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">Taxon</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/character.html">is.character</a></span><span class="op">(</span><span class="va">Trait</span><span class="op">)</span>,</span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">Site</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">Individual_nr</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">is.numeric</a></span><span class="op">(</span><span class="va">Elevation_m</span><span class="op">)</span>,</span>
<span>  </span>
<span>  <span class="fu"><a href="https://lubridate.tidyverse.org/reference/date_utils.html">is.Date</a></span><span class="op">(</span><span class="va">Date</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now the rules can be applied to the dataset using the <code><a href="https://rdrr.io/pkg/validate/man/confront.html">confront()</a></code> function.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/validate/man/confront.html">confront</a></span><span class="op">(</span><span class="va">raw_traits</span>, <span class="va">rules</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/validate/man/validate-summary.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The summary function gives an overview of each rule and how many passes and fails there are. It looks like all the rules are passed.</p>
</section><section id="check-for-duplicates" class="level2" data-number="4.5"><h2 data-number="4.5" class="anchored" data-anchor-id="check-for-duplicates">
<span class="header-section-number">4.5</span> Check for duplicates</h2>
<p>Another common problem is duplicate observations. This can happen when data is entered twice. The why to find duplicates is to check that the combination of variables are unique. In our dataset, we expect that <em>Date</em>, <em>Gradient</em>, <em>Site</em>, <em>PlotID</em>, <em>Individual_nr</em>, <em>ID</em>, <em>Taxon</em> and <em>Trait</em> should be unique, and only occurring once.</p>
<p>To check this, we can use the rule <code><a href="https://rdrr.io/pkg/validate/man/is_unique.html">is_unique()</a></code>.</p>
<p>Note that <em>Value</em> was not included in the <code><a href="https://rdrr.io/pkg/validate/man/is_unique.html">is_unique()</a></code>. This was done intentionally, because a common mistake is to have a duplicate, but with a different value. This is either because one of the variables is wrong, e.g.&nbsp;it has the wrong Site and therefore appears to be a duplicate. Alternatively, the leaf could have been measured twice by accident, which would likely give two slightly different values. When getting a duplicate, these different options for why there is a duplicate have to be considered and carefully checked in the raw data.</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">rules</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/validate/man/validator.html">validator</a></span><span class="op">(</span></span>
<span>  </span>
<span>  <span class="co"># check variable types</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/validate/man/is_unique.html">is_unique</a></span><span class="op">(</span><span class="va">Date</span>, <span class="va">Gradient</span>, <span class="va">Site</span>, <span class="va">PlotID</span>, <span class="va">Individual_nr</span>, <span class="va">ID</span>, <span class="va">Taxon</span>, <span class="va">Trait</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/validate/man/confront.html">confront</a></span><span class="op">(</span><span class="va">raw_traits</span>, <span class="va">rules</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/validate/man/validate-summary.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;   name items passes fails nNA error warning</span></span>
<span><span class="co">#&gt; 1   V1 10298  10296     2   0 FALSE   FALSE</span></span>
<span><span class="co">#&gt;                                                                 expression</span></span>
<span><span class="co">#&gt; 1 is_unique(Date, Gradient, Site, PlotID, Individual_nr, ID, Taxon, Trait)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Two observations fail the rules and are not unique.</p>
<p>The violate package can visualise the number of passes and fails, which can be useful. For this, use the plot function.</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure"><p><img src="03_data_curation_files/figure-html/visualise-duplicates-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption class="figure-caption">A plot showing the fails and passes. Note that there are very few fails compared to passes and the red bar is not visible on the plot.</figcaption></figure>
</div>
</div>
</div>
<p>To fix the problem, we need to know which observation is a duplicate. Here, we can use the function <code><a href="https://rdrr.io/pkg/validate/man/satisfying.html">violating()</a></code> for the data and the results and it will show the duplicate rows.</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/validate/man/satisfying.html">violating</a></span><span class="op">(</span><span class="va">raw_traits</span>, <span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 2 × 10</span></span>
<span><span class="co">#&gt;   Date       Gradient  Site PlotID Individual_nr ID      Taxon     Trait   Value</span></span>
<span><span class="co">#&gt;   &lt;date&gt;     &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;     &lt;chr&gt;   &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 2018-07-20 B            3 C                  3 BEK3638 salix po… Dry_… 0.00275</span></span>
<span><span class="co">#&gt; 2 2018-07-20 B            3 C                  3 BEK3638 salix po… Dry_… 0.00275</span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: Elevation_m &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We get two exact duplicates, where even <em>Value</em> is the same. We can therefore assume that the leaf has only been measured once, but the data has been entered twice.</p>
<p>To fix the problem, we want to remove one of the duplicates. We group by the variables we expect to be unique and use <code>distinct()</code> with the argument <em>.keep_all = TRUE</em> to remove the duplicates.</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">group_by</span><span class="op">(</span><span class="va">Date</span>, <span class="va">Gradient</span>, <span class="va">Site</span>, <span class="va">PlotID</span>, <span class="va">Individual_nr</span>, <span class="va">ID</span>, <span class="va">Taxon</span>, <span class="va">Trait</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">distinct</span><span class="op">(</span>.keep_all <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">ungroup</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; group_by: 8 grouping variables (Date, Gradient, Site, PlotID, Individual_nr, …)</span></span>
<span><span class="co">#&gt; distinct (grouped): removed one row (&lt;1%), 10,297 rows remaining (removed 0 groups, 10,297 groups remaining)</span></span>
<span><span class="co">#&gt; ungroup: no grouping variables remain</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Tidylog shows again what happens and how many rows have been removed. There are 8 grouping variables and as expected, one row is removed, which is the duplicated row.</p>
<p>We can also run the code from above again to check if the duplicate is gone.</p>
</section><section id="check-for-missing-data" class="level2" data-number="4.6"><h2 data-number="4.6" class="anchored" data-anchor-id="check-for-missing-data">
<span class="header-section-number">4.6</span> Check for missing data</h2>
<p>A common problem in a dataset are missing data. There are many reasons for having missing data. For now, we want to find out if we have any NAs in the dataset and if yes where and how many.</p>
<p>A quick way to get an overview of all NAs in the dataset is to select for any NAs in the dataset and summarise how many NAs there are.</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">select</span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/where.html">where</a></span><span class="op">(</span> <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/any.html">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">summarise</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html">everything</a></span><span class="op">(</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; select: dropped 8 variables (Gradient, Site, PlotID, Individual_nr, ID, …)</span></span>
<span><span class="co">#&gt; summarise: now one row and 2 columns, ungrouped</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span><span class="co">#&gt;    Date Value</span></span>
<span><span class="co">#&gt;   &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">#&gt; 1     7     3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The variables <em>Date</em> and <em>Value</em> have NAs. It is not always a problem to have missing data. In this case, Date is not a crucial variable, and we know the data was collected during a few days in July 2018. We could just impute one of these dates. But for now, let’s focus on the NAs in <em>Value.</em></p>
<p>Once the missing values are detected one has to decide if the missing data can be recovered, or if the missing values should be removed from the dataset. After checking all the raw data and notes, we cannot find the Values from these observations and have to conclude that the data is useless. So, we want to remove them. For this we will use the function <code>drop_na()</code> on the variable <em>Value.</em></p>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">drop_na</span><span class="op">(</span><span class="va">Value</span><span class="op">)</span></span>
<span><span class="co">#&gt; drop_na: removed 3 rows (&lt;1%), 10,294 rows remaining</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This operation has removed 3 rows, which is the number of NA’s in this variable.</p>
<p>Missing data can also be detected using the <code>validator</code> package. It is however more tedious to write one rule (<code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code> or <code>!is.na()</code>) for each variable. But it can also be useful, because the <code><a href="https://rdrr.io/r/base/NA.html">is.na()</a></code> function can be combined with <code><a href="https://rdrr.io/r/base/any.html">any()</a></code> or <code><a href="https://rdrr.io/r/base/all.html">all()</a></code>, defining to include/exclude some or all NAs in a variable.</p>
</section><section id="check-range-of-values" class="level2" data-number="4.7"><h2 data-number="4.7" class="anchored" data-anchor-id="check-range-of-values">
<span class="header-section-number">4.7</span> Check range of values</h2>
<p>Some variables might have specific values we want to check. For categorical variables there is usually a list of specific values to test, while for numeric variables, it is more common to have a range of values or upper/lower limits.</p>
<section id="categorical-variables" class="level3" data-number="4.7.1"><h3 data-number="4.7.1" class="anchored" data-anchor-id="categorical-variables">
<span class="header-section-number">4.7.1</span> Categorical variables</h3>
<p>Let’s look at the variable leaf ID, where we have a list of valid values. For this, we need to get a list of valid IDs, using the <code>get_PFTC_envelope_codes</code> function from the PFTCFunctions package.</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co">#remotes::install_github("Plant-Functional-Trait-Course/PFTCFunctions")</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/Plant-Functional-Trait-Course/PFTCFunctions">"PFTCFunctions"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">leaf_ID</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/PFTCFunctions/man/get_PFTC_envelope_codes.html">get_PFTC_envelope_codes</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">32</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s make some rules to check the variables Gradient, Site and leaf_ID.</p>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># rules</span></span>
<span><span class="va">rules</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/validate/man/validator.html">validator</a></span><span class="op">(</span></span>
<span>  <span class="va">Gradient</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"B"</span>, <span class="st">"C"</span><span class="op">)</span>,</span>
<span>  <span class="va">Site</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>,</span>
<span>  <span class="va">ID</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">leaf_ID</span><span class="op">$</span><span class="va">hashcode</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then check the rules in the dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/validate/man/confront.html">confront</a></span><span class="op">(</span><span class="va">raw_traits</span>, <span class="va">rules</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/validate/man/validate-summary.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;   name items passes fails nNA error warning                        expression</span></span>
<span><span class="co">#&gt; 1   V1 10294  10294     0   0 FALSE   FALSE        Gradient %vin% c("B", "C")</span></span>
<span><span class="co">#&gt; 2   V2 10294  10294     0   0 FALSE   FALSE                 Site %vin% c(1:7)</span></span>
<span><span class="co">#&gt; 3   V3 10294  10280    14   0 FALSE   FALSE ID %vin% c(leaf_ID[["hashcode"]])</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are 14 rows with a wrong leaf ID.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/validate/man/satisfying.html">violating</a></span><span class="op">(</span><span class="va">raw_traits</span>, <span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt; # A tibble: 14 × 10</span></span>
<span><span class="co">#&gt;    Date       Gradient  Site PlotID Individual_nr ID      Taxon   Trait    Value</span></span>
<span><span class="co">#&gt;    &lt;date&gt;     &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;   &lt;chr&gt;    &lt;dbl&gt;</span></span>
<span><span class="co">#&gt;  1 2018-07-21 B            1 A                  2 BGB8422 salix … Plan…   0.7   </span></span>
<span><span class="co">#&gt;  2 2018-07-21 B            1 A                  2 BGB8422 salix … Wet_…   0.0132</span></span>
<span><span class="co">#&gt;  3 2018-07-21 B            1 A                  2 BGB8422 salix … Dry_…   0.0028</span></span>
<span><span class="co">#&gt;  4 2018-07-21 B            1 A                  2 BGB8422 salix … Leaf…   0.267 </span></span>
<span><span class="co">#&gt;  5 2018-07-21 B            1 A                  2 BGB8422 salix … Leaf…   0.538 </span></span>
<span><span class="co">#&gt;  6 2018-07-21 B            1 A                  2 BGB8422 salix … SLA_… 192.    </span></span>
<span><span class="co">#&gt;  7 2018-07-21 B            1 A                  2 BGB8422 salix … LDMC    0.212 </span></span>
<span><span class="co">#&gt;  8 2018-07-21 B            1 A                  2 BGB8422 salix … C_pe…  47.0   </span></span>
<span><span class="co">#&gt;  9 2018-07-21 B            1 A                  2 BGB8422 salix … N_pe…   3.27  </span></span>
<span><span class="co">#&gt; 10 2018-07-21 B            1 A                  2 BGB8422 salix … CN_r…  14.4   </span></span>
<span><span class="co">#&gt; 11 2018-07-21 B            1 A                  2 BGB8422 salix … dN15…   4.41  </span></span>
<span><span class="co">#&gt; 12 2018-07-21 B            1 A                  2 BGB8422 salix … dC13… -31.8   </span></span>
<span><span class="co">#&gt; 13 2018-07-21 B            1 A                  2 BGB8422 salix … P_pe…   0.213 </span></span>
<span><span class="co">#&gt; 14 2018-07-21 B            1 A                  2 BGB8422 salix … NP_r…  15.3   </span></span>
<span><span class="co">#&gt; # ℹ 1 more variable: Elevation_m &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The ID BGB8422 does not exist in the list of valid leaf IDs. There might be a typo in this ID. One thing is to search for the letter or number combinations and see if we can figure out where the mistake happened. For this we will use the <code>stringr</code> package, which is part of tidyverse.</p>
<p>With the function <code><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect()</a></code> we can search for specific strings like “BGB” or “8422” in the variable hashcode.</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">leaf_ID</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">hashcode</span>, <span class="st">"8422"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; filter: removed 17,575 rows (&gt;99%), one row remaining</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 1</span></span>
<span><span class="co">#&gt;   hashcode</span></span>
<span><span class="co">#&gt;   &lt;chr&gt;   </span></span>
<span><span class="co">#&gt; 1 BGP8422</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>When searching for the combinations of numbers, we find a ID that is very similar but a B is replaced by the P. This seems like a mistake that could be easily made. The envelope of this sample should also be checked before fixing the error.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 2
</div>
</div>
<div class="callout-body-container callout-body">
<p>Let’s fix the wrong leaf ID, by replacing BGB8422 with BGP8422.</p>
<details><summary><p>Hint</p>
</summary><ul>
<li>use <code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code>
</li>
</ul></details>
</div>
</div>
</section><section id="numeric-variables" class="level3" data-number="4.7.2"><h3 data-number="4.7.2" class="anchored" data-anchor-id="numeric-variables">
<span class="header-section-number">4.7.2</span> Numeric variables</h3>
<p>For numeric variables we could use another set of rules. For example the variable LDMC (Leaf dry matter content) is the dry mass divided by the wet mass. If LDMC is larger than 1 it means that the dry leaf was heavier than the wet leaf, which does not make sense. So, a simple rule to test is that LDMC is between 0 and 1.</p>
<p>For this you could just use <code>Value &lt;= 1</code>. But because we have different traits, we need to use a conditional rule:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># rules</span></span>
<span><span class="va">rules</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/validate/man/validator.html">validator</a></span><span class="op">(</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">Trait</span> <span class="op">==</span> <span class="st">"LDMC"</span><span class="op">)</span> <span class="va">Value</span> <span class="op">&lt;=</span> <span class="fl">1</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And then check the rules in the dataset.</p>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/validate/man/confront.html">confront</a></span><span class="op">(</span><span class="va">raw_traits</span>, <span class="va">rules</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/validate/man/validate-summary.html">summary</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span></span>
<span><span class="co">#&gt;   name items passes fails nNA error warning</span></span>
<span><span class="co">#&gt; 1   V1 10294  10294     0   0 FALSE   FALSE</span></span>
<span><span class="co">#&gt;                               expression</span></span>
<span><span class="co">#&gt; 1 Trait != "LDMC" | (Value - 1 &lt;= 1e-08)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>None of the values is violating the rules, so all is good.</p>
</section></section><section id="check-taxonomy" class="level2" data-number="4.8"><h2 data-number="4.8" class="anchored" data-anchor-id="check-taxonomy">
<span class="header-section-number">4.8</span> Check taxonomy</h2>
<p>A common problem is inconsistencies within variables. In this dataset such a variable is <code>Taxon</code>. It is very common to make mistakes and typos with Latin species names during data entry.</p>
<p>Let’s look at all unique species names using <code>distinct()</code> and sort them by Taxon using <code><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange()</a></code>. This is a good way to see small typos in the species names.</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">distinct</span><span class="op">(</span><span class="va">Taxon</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">Taxon</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span>n <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span></span>
<span><span class="co">#&gt; distinct: removed 10,259 rows (&gt;99%), 35 rows remaining</span></span>
<span><span class="co">#&gt; # A tibble: 35 × 1</span></span>
<span><span class="co">#&gt;    Taxon                   </span></span>
<span><span class="co">#&gt;    &lt;chr&gt;                   </span></span>
<span><span class="co">#&gt;  1 alopecurus ovatus       </span></span>
<span><span class="co">#&gt;  2 bistorta vivipara       </span></span>
<span><span class="co">#&gt;  3 calalmagrostis neglecta </span></span>
<span><span class="co">#&gt;  4 calamagrostis neglecta  </span></span>
<span><span class="co">#&gt;  5 cassiope tetragona      </span></span>
<span><span class="co">#&gt;  6 cerastium arcticum      </span></span>
<span><span class="co">#&gt;  7 draba arctica           </span></span>
<span><span class="co">#&gt;  8 draba oxycarpa          </span></span>
<span><span class="co">#&gt;  9 dryas octopetala        </span></span>
<span><span class="co">#&gt; 10 equisetum arvense       </span></span>
<span><span class="co">#&gt; 11 equisetum scirpoides    </span></span>
<span><span class="co">#&gt; 12 festuca rubra           </span></span>
<span><span class="co">#&gt; 13 festuca viviparoidea    </span></span>
<span><span class="co">#&gt; 14 luzula confusa          </span></span>
<span><span class="co">#&gt; 15 luzula nivalis          </span></span>
<span><span class="co">#&gt; 16 micranthes hieraciifolia</span></span>
<span><span class="co">#&gt; 17 micranthes nivalis      </span></span>
<span><span class="co">#&gt; 18 oxiria digyna           </span></span>
<span><span class="co">#&gt; 19 oxyra digyna            </span></span>
<span><span class="co">#&gt; 20 oxyria digina           </span></span>
<span><span class="co">#&gt; 21 oxyria digyna           </span></span>
<span><span class="co">#&gt; 22 pedicularis hirsuta     </span></span>
<span><span class="co">#&gt; 23 poa alpina              </span></span>
<span><span class="co">#&gt; 24 poa arctica             </span></span>
<span><span class="co">#&gt; 25 poa pratensis           </span></span>
<span><span class="co">#&gt; 26 potentilla hyparctica   </span></span>
<span><span class="co">#&gt; 27 ranunculus sulphureus   </span></span>
<span><span class="co">#&gt; 28 salix polaris           </span></span>
<span><span class="co">#&gt; 29 saxifraga cernua        </span></span>
<span><span class="co">#&gt; 30 saxifraga cespitosa     </span></span>
<span><span class="co">#&gt; 31 saxifraga hirculus      </span></span>
<span><span class="co">#&gt; 32 saxifraga oppositifolia </span></span>
<span><span class="co">#&gt; 33 silene acaulis          </span></span>
<span><span class="co">#&gt; 34 stellaria longipes      </span></span>
<span><span class="co">#&gt; 35 trisetum spicatum</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are four different versions for <em>oxyra digyna</em> and two for <em>calamagrostis neglecta</em>. Obviously, some typos where made when entering the data.</p>
<section id="use-case_when" class="level3" data-number="4.8.1"><h3 data-number="4.8.1" class="anchored" data-anchor-id="use-case_when">
<span class="header-section-number">4.8.1</span> Use case_when()</h3>
<p>Because we have to change multiple species names, we will use <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code>, which allows for multiple conditions.</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Taxon <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">Taxon</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"oxiria digyna"</span>, </span>
<span>                                        <span class="st">"oxyria digina"</span>, </span>
<span>                                        <span class="st">"oxyra digyna"</span><span class="op">)</span> <span class="op">~</span> <span class="st">"oxyria digyna"</span>,</span>
<span>                           <span class="va">Taxon</span> <span class="op">==</span> <span class="st">"calalmagrostis neglecta"</span> <span class="op">~</span> <span class="st">"calamagrostis neglecta"</span>,</span>
<span>                           <span class="cn">TRUE</span> <span class="op">~</span> <span class="va">Taxon</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; mutate: changed 38 values (&lt;1%) of 'Taxon' (0 new NAs)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="use-taxon-dictionary" class="level3" data-number="4.8.2"><h3 data-number="4.8.2" class="anchored" data-anchor-id="use-taxon-dictionary">
<span class="header-section-number">4.8.2</span> Use taxon dictionary</h3>
<p>An alternative to using <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code> to fix the problem, would be to create a dictionary with bad and good species names.</p>
<p>Let’s make a taxon dictionary.</p>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">dictionary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>bad_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"oxiria digyna"</span>, </span>
<span>                                  <span class="st">"oxyria digina"</span>, </span>
<span>                                  <span class="st">"oxyra digyna"</span>, </span>
<span>                                  <span class="st">"calalmagrostis neglecta"</span><span class="op">)</span>,</span>
<span>                     good_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"oxyria digyna"</span>, </span>
<span>                                   <span class="st">"oxyria digyna"</span>, </span>
<span>                                   <span class="st">"oxyria digyna"</span>, </span>
<span>                                   <span class="st">"calamagrostis neglecta"</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next, we need to join the dictionary to the dataset using the bad name column. And with coalesce with can replace the bad names with the good names.</p>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">left_join</span><span class="op">(</span><span class="va">dictionary</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Taxon"</span> <span class="op">=</span> <span class="st">"bad_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Taxon <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/coalesce.html">coalesce</a></span><span class="op">(</span><span class="va">good_name</span>, <span class="va">Taxon</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="checking-taxon-using-tnrs" class="level3" data-number="4.8.3"><h3 data-number="4.8.3" class="anchored" data-anchor-id="checking-taxon-using-tnrs">
<span class="header-section-number">4.8.3</span> Checking Taxon using TNRS</h3>
<p>It is always advisable to check the taxonomy using a database such as TNRS, a Taxonomic Name Resolution Service.</p>
<p>Maitner please add an example using TNRS.</p>
</section></section><section id="visualise-data" class="level2" data-number="4.9"><h2 data-number="4.9" class="anchored" data-anchor-id="visualise-data">
<span class="header-section-number">4.9</span> Visualise data</h2>
<p>Some errors and problems in the data are difficult to detect by looking at the dataset. For example checking if the measurements are realistic is nearly impossible by going through a table with numbers. For this, visualising the data is much more effective.</p>
<section id="histogram-or-density-plot" class="level3" data-number="4.9.1"><h3 data-number="4.9.1" class="anchored" data-anchor-id="histogram-or-density-plot">
<span class="header-section-number">4.9.1</span> Histogram or density plot</h3>
<p>Using histograms or density plots shows you the range of values in a variable. We are showing the density for each trait and colour the two different gradients.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-hist" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="03_data_curation_files/figure-html/fig-hist-1.png" class="img-fluid figure-img" alt="A plto showing the density distributions of all measured traits." width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.2: Density distributions of all measured traits.</figcaption></figure>
</div>
</div>
</div>
<p>Note that the size traits (plant height, leaf mass, area and thickness) have distributions with very long tails. This is common for size related variables and log transformation is common for such variables.</p>
<p>Also not that leaf area has a huge tail and goes up to almost 20’000 cm<sup>2</sup>. This is a leaf of almost 2 m<sup>2</sup>, which is impossible for a plant from Svalbard. This value needs to be checked, it could be a typo.</p>
<p>Let’s log transform the size traits first.</p>
<div class="cell" data-warnigs="false">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span></span>
<span><span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Value_log <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">Trait</span> <span class="op"><a href="https://rdrr.io/r/base/match.html">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Plant_Height_cm"</span>,</span>
<span>    <span class="st">"Wet_Mass_g"</span>,</span>
<span>    <span class="st">"Dry_Mass_g"</span>,</span>
<span>    <span class="st">"Leaf_Area_cm2"</span>,</span>
<span>    <span class="st">"Leaf_Thickness_mm"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">Value</span><span class="op">)</span>, <span class="va">Value</span><span class="op">)</span>,</span>
<span>    Trait <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/recode.html">recode</a></span><span class="op">(</span><span class="va">Trait</span>,</span>
<span>                   <span class="st">"Plant_Height_cm"</span> <span class="op">=</span> <span class="st">"Plant_Height_cm_log"</span>,</span>
<span>                   <span class="st">"Wet_Mass_g"</span> <span class="op">=</span> <span class="st">"Wet_Mass_g_log"</span>,</span>
<span>                   <span class="st">"Dry_Mass_g"</span> <span class="op">=</span> <span class="st">"Dry_Mass_g_log"</span>,</span>
<span>                   <span class="st">"Leaf_Area_cm2"</span> <span class="op">=</span> <span class="st">"Leaf_Area_cm2_log"</span>,</span>
<span>                   <span class="st">"Leaf_Thickness_mm"</span> <span class="op">=</span> <span class="st">"Thickness_mm_log"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: There was 1 warning in `.fun()`.</span></span>
<span><span class="co">#&gt; ℹ In argument: `Value_log = if_else(...)`.</span></span>
<span><span class="co">#&gt; Caused by warning in `log()`:</span></span>
<span><span class="co">#&gt; ! NaNs produced</span></span>
<span><span class="co">#&gt; mutate: changed 5,214 values (51%) of 'Trait' (0 new NAs)</span></span>
<span><span class="co">#&gt;         new variable 'Value_log' (double) with 7,990 unique values and 0% NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>And remake the density plot using the log-transformed values.</p>
<div class="cell">
<div class="cell-output-display">
<div id="fig-hist-log" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="03_data_curation_files/figure-html/fig-hist-log-1.png" class="img-fluid figure-img" alt="A plot showing the density distributions of all measured traits." width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.3: Density distributions of all measured traits.</figcaption></figure>
</div>
</div>
</div>
<p>The size traits do not have a long tail anymore.</p>
<p>Let’s find the giant leaf. For this we can filter observations in the trait <em>Leaf Area</em> that have <em>Value</em> larger than 10.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">filter</span><span class="op">(</span><span class="va">Trait</span> <span class="op">==</span> <span class="st">"Leaf_Area_cm2_log"</span>,</span>
<span>         <span class="va">Value</span> <span class="op">&gt;</span> <span class="fl">10</span><span class="op">)</span></span>
<span><span class="co">#&gt; filter: removed 10,293 rows (&gt;99%), one row remaining</span></span>
<span><span class="co">#&gt; # A tibble: 1 × 11</span></span>
<span><span class="co">#&gt;   Date       Gradient  Site PlotID Individual_nr ID      Taxon       Trait Value</span></span>
<span><span class="co">#&gt;   &lt;date&gt;     &lt;chr&gt;    &lt;dbl&gt; &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;       &lt;chr&gt; &lt;dbl&gt;</span></span>
<span><span class="co">#&gt; 1 2018-07-18 C            5 C                  2 ANH3472 oxyria dig… Leaf… 17965</span></span>
<span><span class="co">#&gt; # ℹ 2 more variables: Elevation_m &lt;dbl&gt;, Value_log &lt;dbl&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This value for <em>Leaf Area</em> is impossible. We can again check the envelope of this leaf to find out if this was a typo. It turns out the comma was missed when typing in the data. Let’s fix the problem with a <code>mutate</code> and <code><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else()</a></code> statement. Note that we have to fix the problem for the <em>Value</em> and <em>Value_log</em> column.</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">raw_traits</span> <span class="op">&lt;-</span> <span class="va">raw_traits</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">mutate</span><span class="op">(</span>Value <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="st">"ANH3472"</span> <span class="op">&amp;</span> <span class="va">Trait</span> <span class="op">==</span> <span class="st">"Leaf_Area_cm2_log"</span>, <span class="fl">1.7965</span>, <span class="va">Value</span><span class="op">)</span>,</span>
<span>         Value_log <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span><span class="va">ID</span> <span class="op">==</span> <span class="st">"ANH3472"</span> <span class="op">&amp;</span> <span class="va">Trait</span> <span class="op">==</span> <span class="st">"Leaf_Area_cm2_log"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="fl">1.7965</span><span class="op">)</span>, <span class="va">Value_log</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; mutate: changed one value (&lt;1%) of 'Value' (0 new NAs)</span></span>
<span><span class="co">#&gt;         changed one value (&lt;1%) of 'Value_log' (0 new NAs)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="correlations" class="level3" data-number="4.9.2"><h3 data-number="4.9.2" class="anchored" data-anchor-id="correlations">
<span class="header-section-number">4.9.2</span> Correlations</h3>
<p>Another way to check the data is to plot variables against each other that should be correlated. In this dataset, we can plot dry mass against leaf area. We would expect a positive correlation between the two variables, where large leaves have a higher dry mass.</p>
<div class="cell">
<pre><code>#&gt; Warning: Removed 39 rows containing missing values or values outside the scale range
#&gt; (`geom_point()`).</code></pre>
<div class="cell-output-display">
<div id="fig-correlation" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="03_data_curation_files/figure-html/fig-correlation-1.png" class="img-fluid figure-img" alt="A plot showing the correlation between leaf area and dry mass. The two variables are positively correlated, but there is a separate point cloud with lower dry mass and area." width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.4: Correlation between leaf area and dry mass.</figcaption></figure>
</div>
</div>
</div>
<p>We see a good correlation between leaf area and dry mass. However, there is a cloud with observations that separate from the main data cloud. These leaves have a lower dry mass and area.</p>
<div class="callout callout-style-default callout-warning no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Exercise 3
</div>
</div>
<div class="callout-body-container callout-body">
<p>What could the problem be?</p>
<details><summary><p>Hint</p>
</summary><ul>
<li>Use <code>filter()</code> to look at the observations that have a higher leaf area and mass and compare them to the rest of the data.</li>
<li>Units</li>
</ul></details>
</div>
</div>
<p>The problem with the separate data points is the unit. They were measured in mg instead of g and are 3 digits off. This can easily be seen, when adding the regression lines for each data cloud, and two lines in between with the same slope but the intercept being 10 times smaller.</p>
<div class="cell">
<pre><code>#&gt; Warning: Removed 39 rows containing missing values or values outside the scale range
#&gt; (`geom_point()`).</code></pre>
<div class="cell-output-display">
<div id="fig-correlation-lines" class="quarto-figure quarto-figure-center anchored">
<figure class="figure"><p><img src="03_data_curation_files/figure-html/fig-correlation-lines-1.png" class="img-fluid figure-img" alt="A plot showing the correlation between leaf area and dry mass." width="672"></p>
<figcaption class="figure-caption">Figure&nbsp;4.5: Correlation between leaf area and dry mass.</figcaption></figure>
</div>
</div>
</div>


<!-- -->

</section></section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  let localAlternateSentinel = 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./02_data_workflow.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Data workflow</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb35" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, setup, include = FALSE}</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">collapse =</span> <span class="cn">TRUE</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">comment =</span> <span class="st">"#&gt;"</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidylog)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(validate)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="fu"># Data cleaning {#sec-data-cleaning}</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>Data cleaning is the first steps after digitizing the data.</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>Each dataset has to be checked for several types of errors and corrected if possible.</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>Some of the checking and correction can be done automatically, but other things have to be done manually.</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>And sometimes we need play detectives to find the problems and the right way to correct errors.</span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>This tutorial shows the main steps for how to check a dataset and make corrections.</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>For this tutorial we will be working with the trait dataset from Svalbard.</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>See chapter @sec-pftc-data for how to access the data and information about the study, experiment and datasets.</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a><span class="fu">## Useful packages</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>There are a couple of R packages that are useful for data curation.</span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>First, **tidyverse** is a collection of R packages used for basic data manipulation and analysis.</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>We will also use **lubridate**, which helps with data and time formats.</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>If you have never used the packages you need to install it first using the function <span class="in">`install.packages("tidyverse")`</span>.</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>Otherwise, you can just load the packages.</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-packages</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>Another useful package for data curation is **tidylog**, which is built on the **dplyr** and **tidyr** packages and provides useful information about the functions used.</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>Tidylog will for example tell you how many rows have been removed and are remaining when using the <span class="in">`filter()`</span> function or how many rows match when using a join function.</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a>The information is always indicated in absolute numbers and percentage.</span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>This additional information is very useful to check if the right observations have been removed or manipulated, because mistakes are easily done.</span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>Let's install and/or load **tidylog**.</span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-tidylog</span></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidylog)</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>Note, that once **tidylog** is loaded it will automatically prioritize the tidylog function before the dplyr and tidyr functions.</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>You actively have to choose if you do not want to use the tidylog version by using this notation: <span class="in">`dplyr::filter()`</span>.</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>Some data checking has to be done by hand and detecitve work, other things can be done more automatically.</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>There are a few packages that can help with some of this work and for this tutorial we will use the <span class="in">`validate`</span> package.</span>
<span id="cb35-69"><a href="#cb35-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-72"><a href="#cb35-72" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-73"><a href="#cb35-73" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: load-validate</span></span>
<span id="cb35-74"><a href="#cb35-74" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-75"><a href="#cb35-75" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb35-76"><a href="#cb35-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-77"><a href="#cb35-77" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("validate")</span></span>
<span id="cb35-78"><a href="#cb35-78" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(validate)</span>
<span id="cb35-79"><a href="#cb35-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-80"><a href="#cb35-80" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-81"><a href="#cb35-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-82"><a href="#cb35-82" aria-hidden="true" tabindex="-1"></a><span class="fu">## Import data</span></span>
<span id="cb35-83"><a href="#cb35-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-84"><a href="#cb35-84" aria-hidden="true" tabindex="-1"></a>The first step is to import the dataset to R.</span>
<span id="cb35-85"><a href="#cb35-85" aria-hidden="true" tabindex="-1"></a>The data is stored as a *csv file* and we can use the function <span class="in">`read_csv()`</span> to import that data.</span>
<span id="cb35-86"><a href="#cb35-86" aria-hidden="true" tabindex="-1"></a>If your data has another format or you are new to importing data, have a look at this <span class="co">[</span><span class="ot">page</span><span class="co">](https://biostats-r.github.io/biostats/workingInR/importing-data-in-r.html)</span>.</span>
<span id="cb35-87"><a href="#cb35-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-88"><a href="#cb35-88" aria-hidden="true" tabindex="-1"></a>Give the dataset a name using a backwards pointing arrow: <span class="in">`&lt;-`</span> The name should indicate that this is the raw data.</span>
<span id="cb35-89"><a href="#cb35-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-92"><a href="#cb35-92" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-93"><a href="#cb35-93" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: trait-import</span></span>
<span id="cb35-94"><a href="#cb35-94" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-95"><a href="#cb35-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-96"><a href="#cb35-96" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"data/PFTC4_Svalbard_2018_Gradient_Traits.csv"</span>)</span>
<span id="cb35-97"><a href="#cb35-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-98"><a href="#cb35-98" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-99"><a href="#cb35-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-100"><a href="#cb35-100" aria-hidden="true" tabindex="-1"></a>The dataset has 11345 rows and 15 columns and a number of numeric, character and date variables.</span>
<span id="cb35-101"><a href="#cb35-101" aria-hidden="true" tabindex="-1"></a>It contains measurements of 14 traits from two elevational gradients on Svalbard.</span>
<span id="cb35-102"><a href="#cb35-102" aria-hidden="true" tabindex="-1"></a>The traits were measured on individual plants from 21 different graminoid and forb species.</span>
<span id="cb35-103"><a href="#cb35-103" aria-hidden="true" tabindex="-1"></a>For more information about the sites, traits and measurements see <span class="co">[</span><span class="ot">here</span><span class="co">](https://github.com/Plant-Functional-Trait-Course/PFTC_4_Svalbard)</span>.</span>
<span id="cb35-104"><a href="#cb35-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-105"><a href="#cb35-105" aria-hidden="true" tabindex="-1"></a>**Some manipulation**</span>
<span id="cb35-106"><a href="#cb35-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-107"><a href="#cb35-107" aria-hidden="true" tabindex="-1"></a>Let us introduce some errors to the dataset.</span>
<span id="cb35-108"><a href="#cb35-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-109"><a href="#cb35-109" aria-hidden="true" tabindex="-1"></a>The code to do this is hidden.</span>
<span id="cb35-110"><a href="#cb35-110" aria-hidden="true" tabindex="-1"></a>But if you want to replicate the code to introduce errors you can find the code from <span class="co">[</span><span class="ot">line 116</span><span class="co">](https://github.com/Plant-Functional-Trait-Course/PFTC_teaching_material/blob/main/quarto_webpage/8_data_curation.qmd)</span>.</span>
<span id="cb35-111"><a href="#cb35-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-114"><a href="#cb35-114" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-115"><a href="#cb35-115" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: introduce-errors</span></span>
<span id="cb35-116"><a href="#cb35-116" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb35-117"><a href="#cb35-117" aria-hidden="true" tabindex="-1"></a><span class="co">#| message: false</span></span>
<span id="cb35-118"><a href="#cb35-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-119"><a href="#cb35-119" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-120"><a href="#cb35-120" aria-hidden="true" tabindex="-1"></a>  <span class="co"># simplify</span></span>
<span id="cb35-121"><a href="#cb35-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Functional_group <span class="sc">==</span> <span class="st">"vascular"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-122"><a href="#cb35-122" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Project, <span class="sc">-</span>Functional_group, <span class="sc">-</span>Year, <span class="sc">-</span>Latitude_N, <span class="sc">-</span>Longitude_E) <span class="sc">|&gt;</span> </span>
<span id="cb35-123"><a href="#cb35-123" aria-hidden="true" tabindex="-1"></a>  <span class="co">#introduce errors</span></span>
<span id="cb35-124"><a href="#cb35-124" aria-hidden="true" tabindex="-1"></a>  <span class="co"># wrong date</span></span>
<span id="cb35-125"><a href="#cb35-125" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">as.character</span>(Date),</span>
<span id="cb35-126"><a href="#cb35-126" aria-hidden="true" tabindex="-1"></a>         <span class="at">Date =</span> <span class="fu">if_else</span>(ID <span class="sc">==</span> <span class="st">"AMO3822"</span>, <span class="st">"18"</span>, Date),</span>
<span id="cb35-127"><a href="#cb35-127" aria-hidden="true" tabindex="-1"></a>         <span class="co"># giant leaf</span></span>
<span id="cb35-128"><a href="#cb35-128" aria-hidden="true" tabindex="-1"></a>         <span class="at">Value =</span> <span class="fu">if_else</span>(ID <span class="sc">==</span> <span class="st">"ANH3472"</span> <span class="sc">&amp;</span> Trait <span class="sc">==</span> <span class="st">"Leaf_Area_cm2"</span>, <span class="dv">17965</span>, Value),</span>
<span id="cb35-129"><a href="#cb35-129" aria-hidden="true" tabindex="-1"></a>         <span class="co"># diverse species names</span></span>
<span id="cb35-130"><a href="#cb35-130" aria-hidden="true" tabindex="-1"></a>         <span class="at">Taxon =</span> <span class="fu">case_when</span>(ID <span class="sc">==</span> <span class="st">"BON2388"</span> <span class="sc">~</span> <span class="st">"oxiria digyna"</span>,</span>
<span id="cb35-131"><a href="#cb35-131" aria-hidden="true" tabindex="-1"></a>                           ID <span class="sc">==</span> <span class="st">"ATX7216"</span> <span class="sc">~</span> <span class="st">"oxyria digina"</span>,</span>
<span id="cb35-132"><a href="#cb35-132" aria-hidden="true" tabindex="-1"></a>                           ID <span class="sc">==</span> <span class="st">"BSV7581"</span> <span class="sc">~</span> <span class="st">"oxyra digyna"</span>,</span>
<span id="cb35-133"><a href="#cb35-133" aria-hidden="true" tabindex="-1"></a>                           ID <span class="sc">==</span> <span class="st">"BUF9439"</span> <span class="sc">~</span> <span class="st">"calalmagrostis neglecta"</span>,</span>
<span id="cb35-134"><a href="#cb35-134" aria-hidden="true" tabindex="-1"></a>                           <span class="cn">TRUE</span> <span class="sc">~</span> Taxon),</span>
<span id="cb35-135"><a href="#cb35-135" aria-hidden="true" tabindex="-1"></a>         <span class="co"># introduce NAs</span></span>
<span id="cb35-136"><a href="#cb35-136" aria-hidden="true" tabindex="-1"></a>         <span class="at">Value =</span> <span class="fu">if_else</span>(ID <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"BLQ1061"</span>, <span class="st">"AZO1656"</span>, <span class="st">"AMV4451"</span>) <span class="sc">&amp;</span> Trait <span class="sc">==</span> <span class="st">"LDMC"</span>, <span class="cn">NA_real_</span>, Value),</span>
<span id="cb35-137"><a href="#cb35-137" aria-hidden="true" tabindex="-1"></a>         <span class="co"># make wrong ID</span></span>
<span id="cb35-138"><a href="#cb35-138" aria-hidden="true" tabindex="-1"></a>         <span class="at">ID =</span> <span class="fu">if_else</span>(ID <span class="sc">==</span> <span class="st">"BGP8422"</span>, <span class="st">"BGB8422"</span>, ID))</span>
<span id="cb35-139"><a href="#cb35-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-140"><a href="#cb35-140" aria-hidden="true" tabindex="-1"></a><span class="co"># add duplicate row</span></span>
<span id="cb35-141"><a href="#cb35-141" aria-hidden="true" tabindex="-1"></a>duplicate <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-142"><a href="#cb35-142" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice</span>(<span class="dv">378</span>)</span>
<span id="cb35-143"><a href="#cb35-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-144"><a href="#cb35-144" aria-hidden="true" tabindex="-1"></a><span class="co"># introduce dry weight measurements with wrong unit (mg instead of g)</span></span>
<span id="cb35-145"><a href="#cb35-145" aria-hidden="true" tabindex="-1"></a>wrong_decimal <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-146"><a href="#cb35-146" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trait <span class="sc">==</span> <span class="st">"Dry_Mass_g"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-147"><a href="#cb35-147" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sample_n</span>(<span class="at">size =</span> <span class="dv">50</span>, <span class="at">replace =</span> <span class="cn">FALSE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-148"><a href="#cb35-148" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Value2 =</span> Value <span class="sc">/</span> <span class="dv">1000</span>)</span>
<span id="cb35-149"><a href="#cb35-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-150"><a href="#cb35-150" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-151"><a href="#cb35-151" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(wrong_decimal, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Date"</span>, <span class="st">"Gradient"</span>, <span class="st">"Site"</span>, <span class="st">"PlotID"</span>, <span class="st">"Individual_nr"</span>, <span class="st">"ID"</span>, <span class="st">"Taxon"</span>, <span class="st">"Trait"</span>, <span class="st">"Value"</span>, <span class="st">"Elevation_m"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb35-152"><a href="#cb35-152" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Value =</span> <span class="fu">if_else</span>(<span class="sc">!</span><span class="fu">is.na</span>(Value2), Value2, Value)) <span class="sc">|&gt;</span> </span>
<span id="cb35-153"><a href="#cb35-153" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="sc">-</span>Value2) <span class="sc">|&gt;</span> </span>
<span id="cb35-154"><a href="#cb35-154" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(duplicate)</span>
<span id="cb35-155"><a href="#cb35-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-156"><a href="#cb35-156" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-157"><a href="#cb35-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-158"><a href="#cb35-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-159"><a href="#cb35-159" aria-hidden="true" tabindex="-1"></a><span class="fu">## View dataset</span></span>
<span id="cb35-160"><a href="#cb35-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-161"><a href="#cb35-161" aria-hidden="true" tabindex="-1"></a>First, we want to have a look at the dataset.</span>
<span id="cb35-162"><a href="#cb35-162" aria-hidden="true" tabindex="-1"></a>By typing <span class="in">`raw_traits`</span> in the console it will display the first rows and columns of the dataset.</span>
<span id="cb35-163"><a href="#cb35-163" aria-hidden="true" tabindex="-1"></a>Note that the last column and many rows are not shown.</span>
<span id="cb35-164"><a href="#cb35-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-167"><a href="#cb35-167" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-168"><a href="#cb35-168" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: display-table</span></span>
<span id="cb35-169"><a href="#cb35-169" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-170"><a href="#cb35-170" aria-hidden="true" tabindex="-1"></a>raw_traits</span>
<span id="cb35-171"><a href="#cb35-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-172"><a href="#cb35-172" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-173"><a href="#cb35-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-174"><a href="#cb35-174" aria-hidden="true" tabindex="-1"></a>At the top you can see that the dataset has <span class="in">`r dim(raw_traits)[1]`</span> observations and <span class="in">`r length(raw_traits)`</span> columns.</span>
<span id="cb35-175"><a href="#cb35-175" aria-hidden="true" tabindex="-1"></a>These numbers give you a first indication if you have imported the right dataset, and if all observations and columns are there.</span>
<span id="cb35-176"><a href="#cb35-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-177"><a href="#cb35-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-178"><a href="#cb35-178" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check variable type</span></span>
<span id="cb35-179"><a href="#cb35-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-180"><a href="#cb35-180" aria-hidden="true" tabindex="-1"></a>One of the things we want to do is checking if all the variables in the dataset have the right type.</span>
<span id="cb35-181"><a href="#cb35-181" aria-hidden="true" tabindex="-1"></a>For each variable the output above indicates the data type just below the variable name.</span>
<span id="cb35-182"><a href="#cb35-182" aria-hidden="true" tabindex="-1"></a>The most common types are *dbl* (numeric or integer), *chr* (character), or *date* (date).</span>
<span id="cb35-183"><a href="#cb35-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-184"><a href="#cb35-184" aria-hidden="true" tabindex="-1"></a>If you are unfamiliar with data types see <span class="co">[</span><span class="ot">here</span><span class="co">](https://biostats-r.github.io/biostats/workingInR/first-steps-in-r.html#data-types-and-objects)</span>.</span>
<span id="cb35-185"><a href="#cb35-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-186"><a href="#cb35-186" aria-hidden="true" tabindex="-1"></a>The first variable *Date* is a character, which does not seem to be correct.</span>
<span id="cb35-187"><a href="#cb35-187" aria-hidden="true" tabindex="-1"></a>This means that one or several observations in this column are not dates.</span>
<span id="cb35-188"><a href="#cb35-188" aria-hidden="true" tabindex="-1"></a>Since we do not expect to have very many dates (the data was collected during a few days), we can check all the different values in *Date*.</span>
<span id="cb35-189"><a href="#cb35-189" aria-hidden="true" tabindex="-1"></a>For this we use the function <span class="in">`distinct()`</span> on the variable *Date*.</span>
<span id="cb35-190"><a href="#cb35-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-191"><a href="#cb35-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-194"><a href="#cb35-194" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-195"><a href="#cb35-195" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: distinct</span></span>
<span id="cb35-196"><a href="#cb35-196" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-197"><a href="#cb35-197" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-198"><a href="#cb35-198" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(Date)</span>
<span id="cb35-199"><a href="#cb35-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-200"><a href="#cb35-200" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-201"><a href="#cb35-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-202"><a href="#cb35-202" aria-hidden="true" tabindex="-1"></a>We see that there are 6 distinct dates in the variable *Date*.</span>
<span id="cb35-203"><a href="#cb35-203" aria-hidden="true" tabindex="-1"></a>One of the dates is "18", which is not a correct date format and turned the variable into a character.</span>
<span id="cb35-204"><a href="#cb35-204" aria-hidden="true" tabindex="-1"></a>Note the additional information from the tidylog package on the <span class="in">`distinct()`</span> function, which shows the number of rows removed and remaining.</span>
<span id="cb35-205"><a href="#cb35-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-206"><a href="#cb35-206" aria-hidden="true" tabindex="-1"></a>The next step is to check which observastion(s) have the wrong date.</span>
<span id="cb35-207"><a href="#cb35-207" aria-hidden="true" tabindex="-1"></a>For this we can use the function <span class="in">`filter()`</span> to extract all observations with the date 18.</span>
<span id="cb35-208"><a href="#cb35-208" aria-hidden="true" tabindex="-1"></a>We can pipe this to <span class="in">`View()`</span>, which will display the whole table in a separate window.</span>
<span id="cb35-209"><a href="#cb35-209" aria-hidden="true" tabindex="-1"></a>Note that for this tutorial, we use a different way of displaying the output</span>
<span id="cb35-210"><a href="#cb35-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-213"><a href="#cb35-213" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-214"><a href="#cb35-214" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: filter-wrong-date</span></span>
<span id="cb35-215"><a href="#cb35-215" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-216"><a href="#cb35-216" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb35-217"><a href="#cb35-217" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-218"><a href="#cb35-218" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">==</span> <span class="st">"18"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-219"><a href="#cb35-219" aria-hidden="true" tabindex="-1"></a>  <span class="fu">View</span>()</span>
<span id="cb35-220"><a href="#cb35-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-221"><a href="#cb35-221" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-222"><a href="#cb35-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-225"><a href="#cb35-225" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-226"><a href="#cb35-226" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: print-wrong-date</span></span>
<span id="cb35-227"><a href="#cb35-227" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb35-228"><a href="#cb35-228" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-229"><a href="#cb35-229" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">==</span> <span class="st">"18"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-230"><a href="#cb35-230" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>()</span>
<span id="cb35-231"><a href="#cb35-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-232"><a href="#cb35-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-233"><a href="#cb35-233" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-234"><a href="#cb35-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-235"><a href="#cb35-235" aria-hidden="true" tabindex="-1"></a>We can see that a single observation (with multiple traits) has the wrong date.</span>
<span id="cb35-236"><a href="#cb35-236" aria-hidden="true" tabindex="-1"></a>There is no way that we would remember on what day this leaf was collected (remember the dataset has <span class="sc">\&gt;</span> 10000 leaves!).</span>
<span id="cb35-237"><a href="#cb35-237" aria-hidden="true" tabindex="-1"></a>We have to start playing detectives now.</span>
<span id="cb35-238"><a href="#cb35-238" aria-hidden="true" tabindex="-1"></a>The only way to find the right date for these observations is to check the raw data (leaves), notes or photos.</span>
<span id="cb35-239"><a href="#cb35-239" aria-hidden="true" tabindex="-1"></a>It is therefore important to keep all the data entry sheets (paper version), take a photo of them and make tidy notes during field work.</span>
<span id="cb35-240"><a href="#cb35-240" aria-hidden="true" tabindex="-1"></a>This is the only way to fix many of the problems.</span>
<span id="cb35-241"><a href="#cb35-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-242"><a href="#cb35-242" aria-hidden="true" tabindex="-1"></a>Luckily, we took pictures from all envelopes of the leaves.</span>
<span id="cb35-243"><a href="#cb35-243" aria-hidden="true" tabindex="-1"></a>The date on the envelope is *18 July 2018* (@fig-envelope), and it seems that there has been a typo.</span>
<span id="cb35-244"><a href="#cb35-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-247"><a href="#cb35-247" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-248"><a href="#cb35-248" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-envelope</span></span>
<span id="cb35-249"><a href="#cb35-249" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb35-250"><a href="#cb35-250" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "The envelope of the leaf with the wrong date."</span></span>
<span id="cb35-251"><a href="#cb35-251" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A photo showing the envelope of the leaf with the wrong date."</span></span>
<span id="cb35-252"><a href="#cb35-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-253"><a href="#cb35-253" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">include_graphics</span>(<span class="st">"./pics/envelope.png"</span>)</span>
<span id="cb35-254"><a href="#cb35-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-255"><a href="#cb35-255" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-256"><a href="#cb35-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-257"><a href="#cb35-257" aria-hidden="true" tabindex="-1"></a>Let's replace the wrong date and give the variable *Date* the right class.</span>
<span id="cb35-258"><a href="#cb35-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-259"><a href="#cb35-259" aria-hidden="true" tabindex="-1"></a>For this we will use the function <span class="in">`mutate()`</span> which adds or manipulates a column.</span>
<span id="cb35-260"><a href="#cb35-260" aria-hidden="true" tabindex="-1"></a>Inside the mutate we will use the <span class="in">`if_else()`</span> function to replace the date for a specific ID.</span>
<span id="cb35-261"><a href="#cb35-261" aria-hidden="true" tabindex="-1"></a>This function is useful for a single condition.</span>
<span id="cb35-262"><a href="#cb35-262" aria-hidden="true" tabindex="-1"></a>However for multiple statements (many if else conditions), we recommend to use the <span class="in">`case_when()`</span> function (see below).</span>
<span id="cb35-263"><a href="#cb35-263" aria-hidden="true" tabindex="-1"></a>To change the class, we use the <span class="in">`ymd()`</span> function from the lubridate package.</span>
<span id="cb35-264"><a href="#cb35-264" aria-hidden="true" tabindex="-1"></a>Note that we now have to assign the table to a new or the same name to make the change permanent.</span>
<span id="cb35-265"><a href="#cb35-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-268"><a href="#cb35-268" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-269"><a href="#cb35-269" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: replace-date</span></span>
<span id="cb35-270"><a href="#cb35-270" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-271"><a href="#cb35-271" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-272"><a href="#cb35-272" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">if_else</span>(ID <span class="sc">==</span> <span class="st">"AMO3822"</span>, <span class="st">"2018-07-18"</span>, Date)) <span class="sc">|&gt;</span> </span>
<span id="cb35-273"><a href="#cb35-273" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date =</span> <span class="fu">ymd</span>(Date))</span>
<span id="cb35-274"><a href="#cb35-274" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb35-275"><a href="#cb35-275" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-276"><a href="#cb35-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-277"><a href="#cb35-277" aria-hidden="true" tabindex="-1"></a>An important step and good practice when cleaning data is to check that the right correction has been done.</span>
<span id="cb35-278"><a href="#cb35-278" aria-hidden="true" tabindex="-1"></a>Here is where the **tidylog** package comes in handy.</span>
<span id="cb35-279"><a href="#cb35-279" aria-hidden="true" tabindex="-1"></a>It shows that for 7 observation Date has been changed.</span>
<span id="cb35-280"><a href="#cb35-280" aria-hidden="true" tabindex="-1"></a>This matches with the number of observations that had a wrong date.</span>
<span id="cb35-281"><a href="#cb35-281" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-282"><a href="#cb35-282" aria-hidden="true" tabindex="-1"></a>To be absolutely sure we can look at the specific leaf (ID == "AMO3822") and see if the date is now corrected.</span>
<span id="cb35-283"><a href="#cb35-283" aria-hidden="true" tabindex="-1"></a>Another way would be to run the <span class="in">`distinct(Date)`</span> function again.</span>
<span id="cb35-284"><a href="#cb35-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-287"><a href="#cb35-287" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-288"><a href="#cb35-288" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: chacke-date</span></span>
<span id="cb35-289"><a href="#cb35-289" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-290"><a href="#cb35-290" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-291"><a href="#cb35-291" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(ID <span class="sc">==</span> <span class="st">"AMO3822"</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-292"><a href="#cb35-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(Date)</span>
<span id="cb35-293"><a href="#cb35-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-294"><a href="#cb35-294" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-295"><a href="#cb35-295" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-296"><a href="#cb35-296" aria-hidden="true" tabindex="-1"></a>The date has been fixed.</span>
<span id="cb35-297"><a href="#cb35-297" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-298"><a href="#cb35-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-299"><a href="#cb35-299" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning icon="false"}</span>
<span id="cb35-300"><a href="#cb35-300" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 1</span></span>
<span id="cb35-301"><a href="#cb35-301" aria-hidden="true" tabindex="-1"></a>Now it is your turn.</span>
<span id="cb35-302"><a href="#cb35-302" aria-hidden="true" tabindex="-1"></a>Check if the data type for the variable *Date* is now correct.</span>
<span id="cb35-303"><a href="#cb35-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-304"><a href="#cb35-304" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;details&gt;</span></span>
<span id="cb35-305"><a href="#cb35-305" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-306"><a href="#cb35-306" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;summary&gt;</span></span>
<span id="cb35-307"><a href="#cb35-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-308"><a href="#cb35-308" aria-hidden="true" tabindex="-1"></a>Hint</span>
<span id="cb35-309"><a href="#cb35-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-310"><a href="#cb35-310" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb35-311"><a href="#cb35-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-312"><a href="#cb35-312" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>type <span class="in">`raw_traits`</span> to look at the whole dataset where the datatype of each variable is indicated</span>
<span id="cb35-313"><a href="#cb35-313" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>use <span class="in">`class(raw_traits$Date)`</span> which will tell you directly what type of class the variable has</span>
<span id="cb35-314"><a href="#cb35-314" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>use <span class="in">`map(raw_traits, class)`</span> to get the class of all variable in the dataframe</span>
<span id="cb35-315"><a href="#cb35-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-316"><a href="#cb35-316" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/details&gt;</span></span>
<span id="cb35-317"><a href="#cb35-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-318"><a href="#cb35-318" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-319"><a href="#cb35-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-320"><a href="#cb35-320" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-321"><a href="#cb35-321" aria-hidden="true" tabindex="-1"></a>Using the <span class="in">`validate`</span> package, we can check all the variables at once.</span>
<span id="cb35-322"><a href="#cb35-322" aria-hidden="true" tabindex="-1"></a>The validate package is based on making some rules that need checking and then applying those rules to a dataset.</span>
<span id="cb35-323"><a href="#cb35-323" aria-hidden="true" tabindex="-1"></a>The rules can be reused and applied to any dataset.</span>
<span id="cb35-324"><a href="#cb35-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-325"><a href="#cb35-325" aria-hidden="true" tabindex="-1"></a>Let's make some rules about data types using the <span class="in">`validator()`</span> function:</span>
<span id="cb35-326"><a href="#cb35-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-329"><a href="#cb35-329" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-330"><a href="#cb35-330" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: make-rules</span></span>
<span id="cb35-331"><a href="#cb35-331" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-332"><a href="#cb35-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-333"><a href="#cb35-333" aria-hidden="true" tabindex="-1"></a><span class="co"># rules</span></span>
<span id="cb35-334"><a href="#cb35-334" aria-hidden="true" tabindex="-1"></a>rules <span class="ot">&lt;-</span> <span class="fu">validator</span>(</span>
<span id="cb35-335"><a href="#cb35-335" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-336"><a href="#cb35-336" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check variable types</span></span>
<span id="cb35-337"><a href="#cb35-337" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.character</span>(Gradient),</span>
<span id="cb35-338"><a href="#cb35-338" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.character</span>(PlotID),</span>
<span id="cb35-339"><a href="#cb35-339" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.character</span>(ID),</span>
<span id="cb35-340"><a href="#cb35-340" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.character</span>(Taxon),</span>
<span id="cb35-341"><a href="#cb35-341" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.character</span>(Trait),</span>
<span id="cb35-342"><a href="#cb35-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-343"><a href="#cb35-343" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.numeric</span>(Site),</span>
<span id="cb35-344"><a href="#cb35-344" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.numeric</span>(Individual_nr),</span>
<span id="cb35-345"><a href="#cb35-345" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.numeric</span>(Value),</span>
<span id="cb35-346"><a href="#cb35-346" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.numeric</span>(Elevation_m),</span>
<span id="cb35-347"><a href="#cb35-347" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-348"><a href="#cb35-348" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is.Date</span>(Date))</span>
<span id="cb35-349"><a href="#cb35-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-350"><a href="#cb35-350" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-351"><a href="#cb35-351" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-352"><a href="#cb35-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-353"><a href="#cb35-353" aria-hidden="true" tabindex="-1"></a>Now the rules can be applied to the dataset using the <span class="in">`confront()`</span> function.</span>
<span id="cb35-354"><a href="#cb35-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-355"><a href="#cb35-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-358"><a href="#cb35-358" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-359"><a href="#cb35-359" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: confront</span></span>
<span id="cb35-360"><a href="#cb35-360" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-361"><a href="#cb35-361" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb35-362"><a href="#cb35-362" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-363"><a href="#cb35-363" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">confront</span>(raw_traits, rules)</span>
<span id="cb35-364"><a href="#cb35-364" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(out)</span>
<span id="cb35-365"><a href="#cb35-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-366"><a href="#cb35-366" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-367"><a href="#cb35-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-368"><a href="#cb35-368" aria-hidden="true" tabindex="-1"></a>The summary function gives an overview of each rule and how many passes and fails there are.</span>
<span id="cb35-369"><a href="#cb35-369" aria-hidden="true" tabindex="-1"></a>It looks like all the rules are passed.</span>
<span id="cb35-370"><a href="#cb35-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-371"><a href="#cb35-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-372"><a href="#cb35-372" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check for duplicates</span></span>
<span id="cb35-373"><a href="#cb35-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-374"><a href="#cb35-374" aria-hidden="true" tabindex="-1"></a>Another common problem is duplicate observations.</span>
<span id="cb35-375"><a href="#cb35-375" aria-hidden="true" tabindex="-1"></a>This can happen when data is entered twice.</span>
<span id="cb35-376"><a href="#cb35-376" aria-hidden="true" tabindex="-1"></a>The why to find duplicates is to check that the combination of variables are unique.</span>
<span id="cb35-377"><a href="#cb35-377" aria-hidden="true" tabindex="-1"></a>In our dataset, we expect that *Date*, *Gradient*, *Site*, *PlotID*, *Individual_nr*, *ID*, *Taxon* and *Trait* should be unique, and only occurring once.</span>
<span id="cb35-378"><a href="#cb35-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-379"><a href="#cb35-379" aria-hidden="true" tabindex="-1"></a>To check this, we can use the rule <span class="in">`is_unique()`</span>.</span>
<span id="cb35-380"><a href="#cb35-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-381"><a href="#cb35-381" aria-hidden="true" tabindex="-1"></a>Note that *Value* was not included in the <span class="in">`is_unique()`</span>.</span>
<span id="cb35-382"><a href="#cb35-382" aria-hidden="true" tabindex="-1"></a>This was done intentionally, because a common mistake is to have a duplicate, but with a different value.</span>
<span id="cb35-383"><a href="#cb35-383" aria-hidden="true" tabindex="-1"></a>This is either because one of the variables is wrong, e.g. it has the wrong Site and therefore appears to be a duplicate.</span>
<span id="cb35-384"><a href="#cb35-384" aria-hidden="true" tabindex="-1"></a>Alternatively, the leaf could have been measured twice by accident, which would likely give two slightly different values.</span>
<span id="cb35-385"><a href="#cb35-385" aria-hidden="true" tabindex="-1"></a>When getting a duplicate, these different options for why there is a duplicate have to be considered and carefully checked in the raw data.</span>
<span id="cb35-386"><a href="#cb35-386" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-389"><a href="#cb35-389" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-390"><a href="#cb35-390" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-duplicates</span></span>
<span id="cb35-391"><a href="#cb35-391" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-392"><a href="#cb35-392" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-393"><a href="#cb35-393" aria-hidden="true" tabindex="-1"></a>rules <span class="ot">&lt;-</span> <span class="fu">validator</span>(</span>
<span id="cb35-394"><a href="#cb35-394" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-395"><a href="#cb35-395" aria-hidden="true" tabindex="-1"></a>  <span class="co"># check variable types</span></span>
<span id="cb35-396"><a href="#cb35-396" aria-hidden="true" tabindex="-1"></a>  <span class="fu">is_unique</span>(Date, Gradient, Site, PlotID, Individual_nr, ID, Taxon, Trait))</span>
<span id="cb35-397"><a href="#cb35-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-398"><a href="#cb35-398" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">confront</span>(raw_traits, rules)</span>
<span id="cb35-399"><a href="#cb35-399" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(out)</span>
<span id="cb35-400"><a href="#cb35-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-401"><a href="#cb35-401" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-402"><a href="#cb35-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-403"><a href="#cb35-403" aria-hidden="true" tabindex="-1"></a>Two observations fail the rules and are not unique.</span>
<span id="cb35-404"><a href="#cb35-404" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-405"><a href="#cb35-405" aria-hidden="true" tabindex="-1"></a>The violate package can visualise the number of passes and fails, which can be useful.</span>
<span id="cb35-406"><a href="#cb35-406" aria-hidden="true" tabindex="-1"></a>For this, use the plot function.</span>
<span id="cb35-407"><a href="#cb35-407" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-410"><a href="#cb35-410" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-411"><a href="#cb35-411" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: visualise-duplicates</span></span>
<span id="cb35-412"><a href="#cb35-412" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: A plot showing the fails and passes. Note that there are very few fails compared to passes and the red bar is not visible on the plot.</span></span>
<span id="cb35-413"><a href="#cb35-413" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-414"><a href="#cb35-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-415"><a href="#cb35-415" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(out)</span>
<span id="cb35-416"><a href="#cb35-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-417"><a href="#cb35-417" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-418"><a href="#cb35-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-419"><a href="#cb35-419" aria-hidden="true" tabindex="-1"></a>To fix the problem, we need to know which observation is a duplicate.</span>
<span id="cb35-420"><a href="#cb35-420" aria-hidden="true" tabindex="-1"></a>Here, we can use the function <span class="in">`violating()`</span> for the data and the results and it will show the duplicate rows.</span>
<span id="cb35-421"><a href="#cb35-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-424"><a href="#cb35-424" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-425"><a href="#cb35-425" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: show-duplicates</span></span>
<span id="cb35-426"><a href="#cb35-426" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-427"><a href="#cb35-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-428"><a href="#cb35-428" aria-hidden="true" tabindex="-1"></a><span class="fu">violating</span>(raw_traits, out)</span>
<span id="cb35-429"><a href="#cb35-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-430"><a href="#cb35-430" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-431"><a href="#cb35-431" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-432"><a href="#cb35-432" aria-hidden="true" tabindex="-1"></a>We get two exact duplicates, where even *Value* is the same.</span>
<span id="cb35-433"><a href="#cb35-433" aria-hidden="true" tabindex="-1"></a>We can therefore assume that the leaf has only been measured once, but the data has been entered twice.</span>
<span id="cb35-434"><a href="#cb35-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-435"><a href="#cb35-435" aria-hidden="true" tabindex="-1"></a>To fix the problem, we want to remove one of the duplicates.</span>
<span id="cb35-436"><a href="#cb35-436" aria-hidden="true" tabindex="-1"></a>We group by the variables we expect to be unique and use <span class="in">`distinct()`</span> with the argument *.keep_all = TRUE* to remove the duplicates.</span>
<span id="cb35-437"><a href="#cb35-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-440"><a href="#cb35-440" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-441"><a href="#cb35-441" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: remove-duplicates</span></span>
<span id="cb35-442"><a href="#cb35-442" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-443"><a href="#cb35-443" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-444"><a href="#cb35-444" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, Gradient, Site, PlotID, Individual_nr, ID, Taxon, Trait) <span class="sc">|&gt;</span> </span>
<span id="cb35-445"><a href="#cb35-445" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(<span class="at">.keep_all =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span> </span>
<span id="cb35-446"><a href="#cb35-446" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb35-447"><a href="#cb35-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-448"><a href="#cb35-448" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-449"><a href="#cb35-449" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-450"><a href="#cb35-450" aria-hidden="true" tabindex="-1"></a>Tidylog shows again what happens and how many rows have been removed.</span>
<span id="cb35-451"><a href="#cb35-451" aria-hidden="true" tabindex="-1"></a>There are 8 grouping variables and as expected, one row is removed, which is the duplicated row.</span>
<span id="cb35-452"><a href="#cb35-452" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-453"><a href="#cb35-453" aria-hidden="true" tabindex="-1"></a>We can also run the code from above again to check if the duplicate is gone.</span>
<span id="cb35-454"><a href="#cb35-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-455"><a href="#cb35-455" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check for missing data</span></span>
<span id="cb35-456"><a href="#cb35-456" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-457"><a href="#cb35-457" aria-hidden="true" tabindex="-1"></a>A common problem in a dataset are missing data.</span>
<span id="cb35-458"><a href="#cb35-458" aria-hidden="true" tabindex="-1"></a>There are many reasons for having missing data.</span>
<span id="cb35-459"><a href="#cb35-459" aria-hidden="true" tabindex="-1"></a>For now, we want to find out if we have any NAs in the dataset and if yes where and how many.</span>
<span id="cb35-460"><a href="#cb35-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-461"><a href="#cb35-461" aria-hidden="true" tabindex="-1"></a>A quick way to get an overview of all NAs in the dataset is to select for any NAs in the dataset and summarise how many NAs there are.</span>
<span id="cb35-462"><a href="#cb35-462" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-465"><a href="#cb35-465" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-466"><a href="#cb35-466" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-na</span></span>
<span id="cb35-467"><a href="#cb35-467" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-468"><a href="#cb35-468" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">%&gt;%</span> </span>
<span id="cb35-469"><a href="#cb35-469" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>( <span class="sc">~</span><span class="fu">any</span>(<span class="fu">is.na</span>(.)))) <span class="sc">%&gt;%</span> </span>
<span id="cb35-470"><a href="#cb35-470" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="fu">across</span>(<span class="fu">everything</span>(), <span class="sc">~</span><span class="fu">sum</span>(<span class="fu">is.na</span>(.))))</span>
<span id="cb35-471"><a href="#cb35-471" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-472"><a href="#cb35-472" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-473"><a href="#cb35-473" aria-hidden="true" tabindex="-1"></a>The variables *Date* and *Value* have NAs.</span>
<span id="cb35-474"><a href="#cb35-474" aria-hidden="true" tabindex="-1"></a>It is not always a problem to have missing data.</span>
<span id="cb35-475"><a href="#cb35-475" aria-hidden="true" tabindex="-1"></a>In this case, Date is not a crucial variable, and we know the data was collected during a few days in July 2018.</span>
<span id="cb35-476"><a href="#cb35-476" aria-hidden="true" tabindex="-1"></a>We could just impute one of these dates.</span>
<span id="cb35-477"><a href="#cb35-477" aria-hidden="true" tabindex="-1"></a>But for now, let's focus on the NAs in *Value.*</span>
<span id="cb35-478"><a href="#cb35-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-479"><a href="#cb35-479" aria-hidden="true" tabindex="-1"></a>Once the missing values are detected one has to decide if the missing data can be recovered, or if the missing values should be removed from the dataset.</span>
<span id="cb35-480"><a href="#cb35-480" aria-hidden="true" tabindex="-1"></a>After checking all the raw data and notes, we cannot find the Values from these observations and have to conclude that the data is useless.</span>
<span id="cb35-481"><a href="#cb35-481" aria-hidden="true" tabindex="-1"></a>So, we want to remove them.</span>
<span id="cb35-482"><a href="#cb35-482" aria-hidden="true" tabindex="-1"></a>For this we will use the function <span class="in">`drop_na()`</span> on the variable *Value.*</span>
<span id="cb35-483"><a href="#cb35-483" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-486"><a href="#cb35-486" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-487"><a href="#cb35-487" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: remove-na</span></span>
<span id="cb35-488"><a href="#cb35-488" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-489"><a href="#cb35-489" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-490"><a href="#cb35-490" aria-hidden="true" tabindex="-1"></a>  <span class="fu">drop_na</span>(Value)</span>
<span id="cb35-491"><a href="#cb35-491" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-492"><a href="#cb35-492" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-493"><a href="#cb35-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-494"><a href="#cb35-494" aria-hidden="true" tabindex="-1"></a>This operation has removed 3 rows, which is the number of NA's in this variable.</span>
<span id="cb35-495"><a href="#cb35-495" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-496"><a href="#cb35-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-497"><a href="#cb35-497" aria-hidden="true" tabindex="-1"></a>Missing data can also be detected using the <span class="in">`validator`</span> package.</span>
<span id="cb35-498"><a href="#cb35-498" aria-hidden="true" tabindex="-1"></a>It is however more tedious to write one rule (<span class="in">`is.na()`</span> or <span class="in">`!is.na()`</span>) for each variable.</span>
<span id="cb35-499"><a href="#cb35-499" aria-hidden="true" tabindex="-1"></a>But it can also be useful, because the <span class="in">`is.na()`</span> function can be combined with <span class="in">`any()`</span> or <span class="in">`all()`</span>, defining to include/exclude some or all NAs in a variable.</span>
<span id="cb35-500"><a href="#cb35-500" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-501"><a href="#cb35-501" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-502"><a href="#cb35-502" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check range of values</span></span>
<span id="cb35-503"><a href="#cb35-503" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-504"><a href="#cb35-504" aria-hidden="true" tabindex="-1"></a>Some variables might have specific values we want to check.</span>
<span id="cb35-505"><a href="#cb35-505" aria-hidden="true" tabindex="-1"></a>For categorical variables there is usually a list of specific values to test, while for numeric variables, it is more common to have a range of values or upper/lower limits.</span>
<span id="cb35-506"><a href="#cb35-506" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-507"><a href="#cb35-507" aria-hidden="true" tabindex="-1"></a><span class="fu">### Categorical variables</span></span>
<span id="cb35-508"><a href="#cb35-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-509"><a href="#cb35-509" aria-hidden="true" tabindex="-1"></a>Let's look at the variable leaf ID, where we have a list of valid values.</span>
<span id="cb35-510"><a href="#cb35-510" aria-hidden="true" tabindex="-1"></a>For this, we need to get a list of valid IDs, using the <span class="in">`get_PFTC_envelope_codes`</span> function from the PFTCFunctions package.</span>
<span id="cb35-511"><a href="#cb35-511" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-514"><a href="#cb35-514" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-515"><a href="#cb35-515" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: make-ids</span></span>
<span id="cb35-516"><a href="#cb35-516" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-517"><a href="#cb35-517" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-518"><a href="#cb35-518" aria-hidden="true" tabindex="-1"></a><span class="co">#remotes::install_github("Plant-Functional-Trait-Course/PFTCFunctions")</span></span>
<span id="cb35-519"><a href="#cb35-519" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-520"><a href="#cb35-520" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(<span class="st">"PFTCFunctions"</span>)</span>
<span id="cb35-521"><a href="#cb35-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-522"><a href="#cb35-522" aria-hidden="true" tabindex="-1"></a>leaf_ID <span class="ot">&lt;-</span> <span class="fu">get_PFTC_envelope_codes</span>(<span class="at">seed =</span> <span class="dv">32</span>)</span>
<span id="cb35-523"><a href="#cb35-523" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-524"><a href="#cb35-524" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-525"><a href="#cb35-525" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-526"><a href="#cb35-526" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-527"><a href="#cb35-527" aria-hidden="true" tabindex="-1"></a>Let's make some rules to check the variables Gradient, Site and leaf_ID.</span>
<span id="cb35-528"><a href="#cb35-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-531"><a href="#cb35-531" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-532"><a href="#cb35-532" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: code-lists</span></span>
<span id="cb35-533"><a href="#cb35-533" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-534"><a href="#cb35-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-535"><a href="#cb35-535" aria-hidden="true" tabindex="-1"></a><span class="co"># rules</span></span>
<span id="cb35-536"><a href="#cb35-536" aria-hidden="true" tabindex="-1"></a>rules <span class="ot">&lt;-</span> <span class="fu">validator</span>(</span>
<span id="cb35-537"><a href="#cb35-537" aria-hidden="true" tabindex="-1"></a>  Gradient <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"B"</span>, <span class="st">"C"</span>),</span>
<span id="cb35-538"><a href="#cb35-538" aria-hidden="true" tabindex="-1"></a>  Site <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">7</span>),</span>
<span id="cb35-539"><a href="#cb35-539" aria-hidden="true" tabindex="-1"></a>  ID <span class="sc">%in%</span> <span class="fu">c</span>(leaf_ID<span class="sc">$</span>hashcode))</span>
<span id="cb35-540"><a href="#cb35-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-541"><a href="#cb35-541" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-542"><a href="#cb35-542" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-543"><a href="#cb35-543" aria-hidden="true" tabindex="-1"></a>And then check the rules in the dataset.</span>
<span id="cb35-544"><a href="#cb35-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-545"><a href="#cb35-545" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-548"><a href="#cb35-548" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-549"><a href="#cb35-549" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: confront-code-lists</span></span>
<span id="cb35-550"><a href="#cb35-550" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-551"><a href="#cb35-551" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-552"><a href="#cb35-552" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">confront</span>(raw_traits, rules)</span>
<span id="cb35-553"><a href="#cb35-553" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(out)</span>
<span id="cb35-554"><a href="#cb35-554" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-555"><a href="#cb35-555" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-556"><a href="#cb35-556" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-557"><a href="#cb35-557" aria-hidden="true" tabindex="-1"></a>There are 14 rows with a wrong leaf ID.</span>
<span id="cb35-558"><a href="#cb35-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-559"><a href="#cb35-559" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-562"><a href="#cb35-562" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-563"><a href="#cb35-563" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: violate-code-lists</span></span>
<span id="cb35-564"><a href="#cb35-564" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-565"><a href="#cb35-565" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-566"><a href="#cb35-566" aria-hidden="true" tabindex="-1"></a><span class="fu">violating</span>(raw_traits, out)</span>
<span id="cb35-567"><a href="#cb35-567" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-568"><a href="#cb35-568" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-569"><a href="#cb35-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-570"><a href="#cb35-570" aria-hidden="true" tabindex="-1"></a>The ID BGB8422 does not exist in the list of valid leaf IDs.</span>
<span id="cb35-571"><a href="#cb35-571" aria-hidden="true" tabindex="-1"></a>There might be a typo in this ID.</span>
<span id="cb35-572"><a href="#cb35-572" aria-hidden="true" tabindex="-1"></a>One thing is to search for the letter or number combinations and see if we can figure out where the mistake happened.</span>
<span id="cb35-573"><a href="#cb35-573" aria-hidden="true" tabindex="-1"></a>For this we will use the <span class="in">`stringr`</span> package, which is part of tidyverse.</span>
<span id="cb35-574"><a href="#cb35-574" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-575"><a href="#cb35-575" aria-hidden="true" tabindex="-1"></a>With the function <span class="in">`str_detect()`</span> we can search for specific strings like "BGB" or "8422" in the variable hashcode.</span>
<span id="cb35-576"><a href="#cb35-576" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-579"><a href="#cb35-579" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-580"><a href="#cb35-580" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: find-wrong-ID</span></span>
<span id="cb35-581"><a href="#cb35-581" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-582"><a href="#cb35-582" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-583"><a href="#cb35-583" aria-hidden="true" tabindex="-1"></a>leaf_ID <span class="sc">|&gt;</span> </span>
<span id="cb35-584"><a href="#cb35-584" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(hashcode, <span class="st">"8422"</span>))</span>
<span id="cb35-585"><a href="#cb35-585" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-586"><a href="#cb35-586" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-587"><a href="#cb35-587" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-588"><a href="#cb35-588" aria-hidden="true" tabindex="-1"></a>When searching for the combinations of numbers, we find a ID that is very similar but a B is replaced by the P.</span>
<span id="cb35-589"><a href="#cb35-589" aria-hidden="true" tabindex="-1"></a>This seems like a mistake that could be easily made.</span>
<span id="cb35-590"><a href="#cb35-590" aria-hidden="true" tabindex="-1"></a>The envelope of this sample should also be checked before fixing the error.</span>
<span id="cb35-591"><a href="#cb35-591" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-592"><a href="#cb35-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-593"><a href="#cb35-593" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning icon="false"}</span>
<span id="cb35-594"><a href="#cb35-594" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 2</span></span>
<span id="cb35-595"><a href="#cb35-595" aria-hidden="true" tabindex="-1"></a>Let's fix the wrong leaf ID, by replacing BGB8422 with BGP8422.</span>
<span id="cb35-596"><a href="#cb35-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-597"><a href="#cb35-597" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;details&gt;</span></span>
<span id="cb35-598"><a href="#cb35-598" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-599"><a href="#cb35-599" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;summary&gt;</span></span>
<span id="cb35-600"><a href="#cb35-600" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-601"><a href="#cb35-601" aria-hidden="true" tabindex="-1"></a>Hint</span>
<span id="cb35-602"><a href="#cb35-602" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-603"><a href="#cb35-603" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb35-604"><a href="#cb35-604" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-605"><a href="#cb35-605" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>use <span class="in">`if_else()`</span></span>
<span id="cb35-606"><a href="#cb35-606" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-607"><a href="#cb35-607" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/details&gt;</span></span>
<span id="cb35-608"><a href="#cb35-608" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-609"><a href="#cb35-609" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-610"><a href="#cb35-610" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-611"><a href="#cb35-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-612"><a href="#cb35-612" aria-hidden="true" tabindex="-1"></a><span class="fu">### Numeric variables</span></span>
<span id="cb35-613"><a href="#cb35-613" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-614"><a href="#cb35-614" aria-hidden="true" tabindex="-1"></a>For numeric variables we could use another set of rules.</span>
<span id="cb35-615"><a href="#cb35-615" aria-hidden="true" tabindex="-1"></a>For example the variable LDMC (Leaf dry matter content) is the dry mass divided by the wet mass.</span>
<span id="cb35-616"><a href="#cb35-616" aria-hidden="true" tabindex="-1"></a>If LDMC is larger than 1 it means that the dry leaf was heavier than the wet leaf, which does not make sense.</span>
<span id="cb35-617"><a href="#cb35-617" aria-hidden="true" tabindex="-1"></a>So, a simple rule to test is that LDMC is between 0 and 1.</span>
<span id="cb35-618"><a href="#cb35-618" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-619"><a href="#cb35-619" aria-hidden="true" tabindex="-1"></a>For this you could just use <span class="in">`Value &lt;= 1`</span>.</span>
<span id="cb35-620"><a href="#cb35-620" aria-hidden="true" tabindex="-1"></a>But because we have different traits, we need to use a conditional rule:</span>
<span id="cb35-621"><a href="#cb35-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-624"><a href="#cb35-624" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-625"><a href="#cb35-625" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: check-ldmc</span></span>
<span id="cb35-626"><a href="#cb35-626" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-627"><a href="#cb35-627" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-628"><a href="#cb35-628" aria-hidden="true" tabindex="-1"></a><span class="co"># rules</span></span>
<span id="cb35-629"><a href="#cb35-629" aria-hidden="true" tabindex="-1"></a>rules <span class="ot">&lt;-</span> <span class="fu">validator</span>(</span>
<span id="cb35-630"><a href="#cb35-630" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (Trait <span class="sc">==</span> <span class="st">"LDMC"</span>) Value <span class="sc">&lt;=</span> <span class="dv">1</span>)</span>
<span id="cb35-631"><a href="#cb35-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-632"><a href="#cb35-632" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-633"><a href="#cb35-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-634"><a href="#cb35-634" aria-hidden="true" tabindex="-1"></a>And then check the rules in the dataset.</span>
<span id="cb35-635"><a href="#cb35-635" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-636"><a href="#cb35-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-639"><a href="#cb35-639" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-640"><a href="#cb35-640" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: confront-ldmc</span></span>
<span id="cb35-641"><a href="#cb35-641" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-642"><a href="#cb35-642" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-643"><a href="#cb35-643" aria-hidden="true" tabindex="-1"></a>out <span class="ot">&lt;-</span> <span class="fu">confront</span>(raw_traits, rules)</span>
<span id="cb35-644"><a href="#cb35-644" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(out)</span>
<span id="cb35-645"><a href="#cb35-645" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-646"><a href="#cb35-646" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-647"><a href="#cb35-647" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-648"><a href="#cb35-648" aria-hidden="true" tabindex="-1"></a>None of the values is violating the rules, so all is good.</span>
<span id="cb35-649"><a href="#cb35-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-650"><a href="#cb35-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-651"><a href="#cb35-651" aria-hidden="true" tabindex="-1"></a><span class="fu">## Check taxonomy</span></span>
<span id="cb35-652"><a href="#cb35-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-653"><a href="#cb35-653" aria-hidden="true" tabindex="-1"></a>A common problem is inconsistencies within variables.</span>
<span id="cb35-654"><a href="#cb35-654" aria-hidden="true" tabindex="-1"></a>In this dataset such a variable is <span class="in">`Taxon`</span>.</span>
<span id="cb35-655"><a href="#cb35-655" aria-hidden="true" tabindex="-1"></a>It is very common to make mistakes and typos with Latin species names during data entry.</span>
<span id="cb35-656"><a href="#cb35-656" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-657"><a href="#cb35-657" aria-hidden="true" tabindex="-1"></a>Let's look at all unique species names using <span class="in">`distinct()`</span> and sort them by Taxon using <span class="in">`arrange()`</span>.</span>
<span id="cb35-658"><a href="#cb35-658" aria-hidden="true" tabindex="-1"></a>This is a good way to see small typos in the species names.</span>
<span id="cb35-659"><a href="#cb35-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-662"><a href="#cb35-662" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-663"><a href="#cb35-663" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: unique-names</span></span>
<span id="cb35-664"><a href="#cb35-664" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-665"><a href="#cb35-665" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-666"><a href="#cb35-666" aria-hidden="true" tabindex="-1"></a>  <span class="fu">distinct</span>(Taxon) <span class="sc">|&gt;</span> </span>
<span id="cb35-667"><a href="#cb35-667" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(Taxon) <span class="sc">|&gt;</span> </span>
<span id="cb35-668"><a href="#cb35-668" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(<span class="at">n =</span> <span class="cn">Inf</span>)</span>
<span id="cb35-669"><a href="#cb35-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-670"><a href="#cb35-670" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-671"><a href="#cb35-671" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-672"><a href="#cb35-672" aria-hidden="true" tabindex="-1"></a>There are four different versions for *oxyra digyna* and two for *calamagrostis neglecta*.</span>
<span id="cb35-673"><a href="#cb35-673" aria-hidden="true" tabindex="-1"></a>Obviously, some typos where made when entering the data.</span>
<span id="cb35-674"><a href="#cb35-674" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-675"><a href="#cb35-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-676"><a href="#cb35-676" aria-hidden="true" tabindex="-1"></a><span class="fu">### Use case_when()</span></span>
<span id="cb35-677"><a href="#cb35-677" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-678"><a href="#cb35-678" aria-hidden="true" tabindex="-1"></a>Because we have to change multiple species names, we will use <span class="in">`case_when()`</span>, which allows for multiple conditions.</span>
<span id="cb35-679"><a href="#cb35-679" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-682"><a href="#cb35-682" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-683"><a href="#cb35-683" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fix-oxyra</span></span>
<span id="cb35-684"><a href="#cb35-684" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-685"><a href="#cb35-685" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-686"><a href="#cb35-686" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Taxon =</span> <span class="fu">case_when</span>(Taxon <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"oxiria digyna"</span>, </span>
<span id="cb35-687"><a href="#cb35-687" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">"oxyria digina"</span>, </span>
<span id="cb35-688"><a href="#cb35-688" aria-hidden="true" tabindex="-1"></a>                                        <span class="st">"oxyra digyna"</span>) <span class="sc">~</span> <span class="st">"oxyria digyna"</span>,</span>
<span id="cb35-689"><a href="#cb35-689" aria-hidden="true" tabindex="-1"></a>                           Taxon <span class="sc">==</span> <span class="st">"calalmagrostis neglecta"</span> <span class="sc">~</span> <span class="st">"calamagrostis neglecta"</span>,</span>
<span id="cb35-690"><a href="#cb35-690" aria-hidden="true" tabindex="-1"></a>                           <span class="cn">TRUE</span> <span class="sc">~</span> Taxon))</span>
<span id="cb35-691"><a href="#cb35-691" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-692"><a href="#cb35-692" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-693"><a href="#cb35-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-694"><a href="#cb35-694" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-695"><a href="#cb35-695" aria-hidden="true" tabindex="-1"></a><span class="fu">### Use taxon dictionary</span></span>
<span id="cb35-696"><a href="#cb35-696" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-697"><a href="#cb35-697" aria-hidden="true" tabindex="-1"></a>An alternative to using <span class="in">`case_when()`</span> to fix the problem, would be to create a dictionary with bad and good species names.</span>
<span id="cb35-698"><a href="#cb35-698" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-699"><a href="#cb35-699" aria-hidden="true" tabindex="-1"></a>Let's make a taxon dictionary.</span>
<span id="cb35-700"><a href="#cb35-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-703"><a href="#cb35-703" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-704"><a href="#cb35-704" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: dictionary</span></span>
<span id="cb35-705"><a href="#cb35-705" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-706"><a href="#cb35-706" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb35-707"><a href="#cb35-707" aria-hidden="true" tabindex="-1"></a>dictionary <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">bad_name =</span> <span class="fu">c</span>(<span class="st">"oxiria digyna"</span>, </span>
<span id="cb35-708"><a href="#cb35-708" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"oxyria digina"</span>, </span>
<span id="cb35-709"><a href="#cb35-709" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"oxyra digyna"</span>, </span>
<span id="cb35-710"><a href="#cb35-710" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"calalmagrostis neglecta"</span>),</span>
<span id="cb35-711"><a href="#cb35-711" aria-hidden="true" tabindex="-1"></a>                     <span class="at">good_name =</span> <span class="fu">c</span>(<span class="st">"oxyria digyna"</span>, </span>
<span id="cb35-712"><a href="#cb35-712" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"oxyria digyna"</span>, </span>
<span id="cb35-713"><a href="#cb35-713" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"oxyria digyna"</span>, </span>
<span id="cb35-714"><a href="#cb35-714" aria-hidden="true" tabindex="-1"></a>                                   <span class="st">"calamagrostis neglecta"</span>))</span>
<span id="cb35-715"><a href="#cb35-715" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-716"><a href="#cb35-716" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-717"><a href="#cb35-717" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-718"><a href="#cb35-718" aria-hidden="true" tabindex="-1"></a>Next, we need to join the dictionary to the dataset using the bad name column.</span>
<span id="cb35-719"><a href="#cb35-719" aria-hidden="true" tabindex="-1"></a>And with coalesce with can replace the bad names with the good names.</span>
<span id="cb35-720"><a href="#cb35-720" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-723"><a href="#cb35-723" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-724"><a href="#cb35-724" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: ix-with-dictionary</span></span>
<span id="cb35-725"><a href="#cb35-725" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-726"><a href="#cb35-726" aria-hidden="true" tabindex="-1"></a><span class="co">#| eval: false</span></span>
<span id="cb35-727"><a href="#cb35-727" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-728"><a href="#cb35-728" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(dictionary, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"Taxon"</span> <span class="ot">=</span> <span class="st">"bad_name"</span>)) <span class="sc">|&gt;</span> </span>
<span id="cb35-729"><a href="#cb35-729" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Taxon =</span> <span class="fu">coalesce</span>(good_name, Taxon))</span>
<span id="cb35-730"><a href="#cb35-730" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-731"><a href="#cb35-731" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-732"><a href="#cb35-732" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-733"><a href="#cb35-733" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-734"><a href="#cb35-734" aria-hidden="true" tabindex="-1"></a><span class="fu">### Checking Taxon using TNRS</span></span>
<span id="cb35-735"><a href="#cb35-735" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-736"><a href="#cb35-736" aria-hidden="true" tabindex="-1"></a>It is always advisable to check the taxonomy using a database such as TNRS, a Taxonomic Name Resolution Service.</span>
<span id="cb35-737"><a href="#cb35-737" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-738"><a href="#cb35-738" aria-hidden="true" tabindex="-1"></a>Maitner please add an example using TNRS.</span>
<span id="cb35-739"><a href="#cb35-739" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-740"><a href="#cb35-740" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-741"><a href="#cb35-741" aria-hidden="true" tabindex="-1"></a><span class="fu">## Visualise data</span></span>
<span id="cb35-742"><a href="#cb35-742" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-743"><a href="#cb35-743" aria-hidden="true" tabindex="-1"></a>Some errors and problems in the data are difficult to detect by looking at the dataset.</span>
<span id="cb35-744"><a href="#cb35-744" aria-hidden="true" tabindex="-1"></a>For example checking if the measurements are realistic is nearly impossible by going through a table with numbers.</span>
<span id="cb35-745"><a href="#cb35-745" aria-hidden="true" tabindex="-1"></a>For this, visualising the data is much more effective.</span>
<span id="cb35-746"><a href="#cb35-746" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-747"><a href="#cb35-747" aria-hidden="true" tabindex="-1"></a><span class="fu">### Histogram or density plot</span></span>
<span id="cb35-748"><a href="#cb35-748" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-749"><a href="#cb35-749" aria-hidden="true" tabindex="-1"></a>Using histograms or density plots shows you the range of values in a variable.</span>
<span id="cb35-750"><a href="#cb35-750" aria-hidden="true" tabindex="-1"></a>We are showing the density for each trait and colour the two different gradients.</span>
<span id="cb35-751"><a href="#cb35-751" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-752"><a href="#cb35-752" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, hist}</span></span>
<span id="cb35-753"><a href="#cb35-753" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-hist</span></span>
<span id="cb35-754"><a href="#cb35-754" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Density distributions of all measured traits."</span></span>
<span id="cb35-755"><a href="#cb35-755" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A plto showing the density distributions of all measured traits."</span></span>
<span id="cb35-756"><a href="#cb35-756" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb35-757"><a href="#cb35-757" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-758"><a href="#cb35-758" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Value, <span class="at">fill =</span> Gradient)) <span class="sc">+</span></span>
<span id="cb35-759"><a href="#cb35-759" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb35-760"><a href="#cb35-760" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"green4"</span>, <span class="st">"grey"</span>)) <span class="sc">+</span></span>
<span id="cb35-761"><a href="#cb35-761" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Trait, <span class="at">scales =</span> <span class="st">"free"</span>)</span>
<span id="cb35-762"><a href="#cb35-762" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-763"><a href="#cb35-763" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-764"><a href="#cb35-764" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-765"><a href="#cb35-765" aria-hidden="true" tabindex="-1"></a>Note that the size traits (plant height, leaf mass, area and thickness) have distributions with very long tails.</span>
<span id="cb35-766"><a href="#cb35-766" aria-hidden="true" tabindex="-1"></a>This is common for size related variables and log transformation is common for such variables.</span>
<span id="cb35-767"><a href="#cb35-767" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-768"><a href="#cb35-768" aria-hidden="true" tabindex="-1"></a>Also not that leaf area has a huge tail and goes up to almost 20'000 cm^2^.</span>
<span id="cb35-769"><a href="#cb35-769" aria-hidden="true" tabindex="-1"></a>This is a leaf of almost 2 m^2^, which is impossible for a plant from Svalbard.</span>
<span id="cb35-770"><a href="#cb35-770" aria-hidden="true" tabindex="-1"></a>This value needs to be checked, it could be a typo.</span>
<span id="cb35-771"><a href="#cb35-771" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-772"><a href="#cb35-772" aria-hidden="true" tabindex="-1"></a>Let's log transform the size traits first.</span>
<span id="cb35-773"><a href="#cb35-773" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-776"><a href="#cb35-776" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-777"><a href="#cb35-777" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: log-transform</span></span>
<span id="cb35-778"><a href="#cb35-778" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-779"><a href="#cb35-779" aria-hidden="true" tabindex="-1"></a><span class="co">#| warnigs: false</span></span>
<span id="cb35-780"><a href="#cb35-780" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-781"><a href="#cb35-781" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-782"><a href="#cb35-782" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-783"><a href="#cb35-783" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Value_log =</span> <span class="fu">if_else</span>(Trait <span class="sc">%in%</span> <span class="fu">c</span>(</span>
<span id="cb35-784"><a href="#cb35-784" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Plant_Height_cm"</span>,</span>
<span id="cb35-785"><a href="#cb35-785" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Wet_Mass_g"</span>,</span>
<span id="cb35-786"><a href="#cb35-786" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Dry_Mass_g"</span>,</span>
<span id="cb35-787"><a href="#cb35-787" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Leaf_Area_cm2"</span>,</span>
<span id="cb35-788"><a href="#cb35-788" aria-hidden="true" tabindex="-1"></a>    <span class="st">"Leaf_Thickness_mm"</span>), <span class="fu">log</span>(Value), Value),</span>
<span id="cb35-789"><a href="#cb35-789" aria-hidden="true" tabindex="-1"></a>    <span class="at">Trait =</span> <span class="fu">recode</span>(Trait,</span>
<span id="cb35-790"><a href="#cb35-790" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Plant_Height_cm"</span> <span class="ot">=</span> <span class="st">"Plant_Height_cm_log"</span>,</span>
<span id="cb35-791"><a href="#cb35-791" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Wet_Mass_g"</span> <span class="ot">=</span> <span class="st">"Wet_Mass_g_log"</span>,</span>
<span id="cb35-792"><a href="#cb35-792" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Dry_Mass_g"</span> <span class="ot">=</span> <span class="st">"Dry_Mass_g_log"</span>,</span>
<span id="cb35-793"><a href="#cb35-793" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Leaf_Area_cm2"</span> <span class="ot">=</span> <span class="st">"Leaf_Area_cm2_log"</span>,</span>
<span id="cb35-794"><a href="#cb35-794" aria-hidden="true" tabindex="-1"></a>                   <span class="st">"Leaf_Thickness_mm"</span> <span class="ot">=</span> <span class="st">"Thickness_mm_log"</span>))</span>
<span id="cb35-795"><a href="#cb35-795" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-796"><a href="#cb35-796" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-797"><a href="#cb35-797" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-798"><a href="#cb35-798" aria-hidden="true" tabindex="-1"></a>And remake the density plot using the log-transformed values.</span>
<span id="cb35-799"><a href="#cb35-799" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-800"><a href="#cb35-800" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, hist-log}</span></span>
<span id="cb35-801"><a href="#cb35-801" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-hist-log</span></span>
<span id="cb35-802"><a href="#cb35-802" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Density distributions of all measured traits."</span></span>
<span id="cb35-803"><a href="#cb35-803" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A plot showing the density distributions of all measured traits."</span></span>
<span id="cb35-804"><a href="#cb35-804" aria-hidden="true" tabindex="-1"></a><span class="co">#| </span></span>
<span id="cb35-805"><a href="#cb35-805" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-806"><a href="#cb35-806" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Value_log, <span class="at">fill =</span> Gradient)) <span class="sc">+</span></span>
<span id="cb35-807"><a href="#cb35-807" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>(<span class="at">alpha =</span> <span class="fl">0.7</span>) <span class="sc">+</span></span>
<span id="cb35-808"><a href="#cb35-808" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">"green4"</span>, <span class="st">"grey"</span>)) <span class="sc">+</span></span>
<span id="cb35-809"><a href="#cb35-809" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span> Trait, <span class="at">scales =</span> <span class="st">"free"</span>)</span>
<span id="cb35-810"><a href="#cb35-810" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-811"><a href="#cb35-811" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-812"><a href="#cb35-812" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-813"><a href="#cb35-813" aria-hidden="true" tabindex="-1"></a>The size traits do not have a long tail anymore.</span>
<span id="cb35-814"><a href="#cb35-814" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-815"><a href="#cb35-815" aria-hidden="true" tabindex="-1"></a>Let's find the giant leaf.</span>
<span id="cb35-816"><a href="#cb35-816" aria-hidden="true" tabindex="-1"></a>For this we can filter observations in the trait *Leaf Area* that have *Value* larger than 10.</span>
<span id="cb35-817"><a href="#cb35-817" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-820"><a href="#cb35-820" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-821"><a href="#cb35-821" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: giant-leaf</span></span>
<span id="cb35-822"><a href="#cb35-822" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-823"><a href="#cb35-823" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-824"><a href="#cb35-824" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(Trait <span class="sc">==</span> <span class="st">"Leaf_Area_cm2_log"</span>,</span>
<span id="cb35-825"><a href="#cb35-825" aria-hidden="true" tabindex="-1"></a>         Value <span class="sc">&gt;</span> <span class="dv">10</span>)</span>
<span id="cb35-826"><a href="#cb35-826" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-827"><a href="#cb35-827" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-828"><a href="#cb35-828" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-829"><a href="#cb35-829" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-830"><a href="#cb35-830" aria-hidden="true" tabindex="-1"></a>This value for *Leaf Area* is impossible.</span>
<span id="cb35-831"><a href="#cb35-831" aria-hidden="true" tabindex="-1"></a>We can again check the envelope of this leaf to find out if this was a typo.</span>
<span id="cb35-832"><a href="#cb35-832" aria-hidden="true" tabindex="-1"></a>It turns out the comma was missed when typing in the data.</span>
<span id="cb35-833"><a href="#cb35-833" aria-hidden="true" tabindex="-1"></a>Let's fix the problem with a <span class="in">`mutate`</span> and <span class="in">`if_else()`</span> statement.</span>
<span id="cb35-834"><a href="#cb35-834" aria-hidden="true" tabindex="-1"></a>Note that we have to fix the problem for the *Value* and *Value_log* column.</span>
<span id="cb35-835"><a href="#cb35-835" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-836"><a href="#cb35-836" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-839"><a href="#cb35-839" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-840"><a href="#cb35-840" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fix-giant-leaf</span></span>
<span id="cb35-841"><a href="#cb35-841" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: true</span></span>
<span id="cb35-842"><a href="#cb35-842" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-843"><a href="#cb35-843" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="ot">&lt;-</span> raw_traits <span class="sc">|&gt;</span> </span>
<span id="cb35-844"><a href="#cb35-844" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Value =</span> <span class="fu">if_else</span>(ID <span class="sc">==</span> <span class="st">"ANH3472"</span> <span class="sc">&amp;</span> Trait <span class="sc">==</span> <span class="st">"Leaf_Area_cm2_log"</span>, <span class="fl">1.7965</span>, Value),</span>
<span id="cb35-845"><a href="#cb35-845" aria-hidden="true" tabindex="-1"></a>         <span class="at">Value_log =</span> <span class="fu">if_else</span>(ID <span class="sc">==</span> <span class="st">"ANH3472"</span> <span class="sc">&amp;</span> Trait <span class="sc">==</span> <span class="st">"Leaf_Area_cm2_log"</span>, <span class="fu">log</span>(<span class="fl">1.7965</span>), Value_log))</span>
<span id="cb35-846"><a href="#cb35-846" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-847"><a href="#cb35-847" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-848"><a href="#cb35-848" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-849"><a href="#cb35-849" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-850"><a href="#cb35-850" aria-hidden="true" tabindex="-1"></a><span class="fu">### Correlations</span></span>
<span id="cb35-851"><a href="#cb35-851" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-852"><a href="#cb35-852" aria-hidden="true" tabindex="-1"></a>Another way to check the data is to plot variables against each other that should be correlated.</span>
<span id="cb35-853"><a href="#cb35-853" aria-hidden="true" tabindex="-1"></a>In this dataset, we can plot dry mass against leaf area.</span>
<span id="cb35-854"><a href="#cb35-854" aria-hidden="true" tabindex="-1"></a>We would expect a positive correlation between the two variables, where large leaves have a higher dry mass.</span>
<span id="cb35-855"><a href="#cb35-855" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-858"><a href="#cb35-858" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-859"><a href="#cb35-859" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-correlation</span></span>
<span id="cb35-860"><a href="#cb35-860" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Correlation between leaf area and dry mass."</span></span>
<span id="cb35-861"><a href="#cb35-861" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A plot showing the correlation between leaf area and dry mass. The two variables are positively correlated, but there is a separate point cloud with lower dry mass and area."</span></span>
<span id="cb35-862"><a href="#cb35-862" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-863"><a href="#cb35-863" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span></span>
<span id="cb35-864"><a href="#cb35-864" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Value) <span class="sc">|&gt;</span> </span>
<span id="cb35-865"><a href="#cb35-865" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Trait, <span class="at">values_from =</span> Value_log) <span class="sc">|&gt;</span></span>
<span id="cb35-866"><a href="#cb35-866" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Dry_Mass_g_log, <span class="at">y =</span> Leaf_Area_cm2_log)) <span class="sc">+</span></span>
<span id="cb35-867"><a href="#cb35-867" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>()</span>
<span id="cb35-868"><a href="#cb35-868" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-869"><a href="#cb35-869" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-870"><a href="#cb35-870" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-871"><a href="#cb35-871" aria-hidden="true" tabindex="-1"></a>We see a good correlation between leaf area and dry mass.</span>
<span id="cb35-872"><a href="#cb35-872" aria-hidden="true" tabindex="-1"></a>However, there is a cloud with observations that separate from the main data cloud.</span>
<span id="cb35-873"><a href="#cb35-873" aria-hidden="true" tabindex="-1"></a>These leaves have a lower dry mass and area.</span>
<span id="cb35-874"><a href="#cb35-874" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-875"><a href="#cb35-875" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-876"><a href="#cb35-876" aria-hidden="true" tabindex="-1"></a>::: {.callout-warning icon="false"}</span>
<span id="cb35-877"><a href="#cb35-877" aria-hidden="true" tabindex="-1"></a><span class="fu">## Exercise 3</span></span>
<span id="cb35-878"><a href="#cb35-878" aria-hidden="true" tabindex="-1"></a>What could the problem be?</span>
<span id="cb35-879"><a href="#cb35-879" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-880"><a href="#cb35-880" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;details&gt;</span></span>
<span id="cb35-881"><a href="#cb35-881" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-882"><a href="#cb35-882" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;summary&gt;</span></span>
<span id="cb35-883"><a href="#cb35-883" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-884"><a href="#cb35-884" aria-hidden="true" tabindex="-1"></a>Hint</span>
<span id="cb35-885"><a href="#cb35-885" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-886"><a href="#cb35-886" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/summary&gt;</span></span>
<span id="cb35-887"><a href="#cb35-887" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-888"><a href="#cb35-888" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Use <span class="in">`filter()`</span> to look at the observations that have a higher leaf area and mass and compare them to the rest of the data.</span>
<span id="cb35-889"><a href="#cb35-889" aria-hidden="true" tabindex="-1"></a><span class="ss">-   </span>Units</span>
<span id="cb35-890"><a href="#cb35-890" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-891"><a href="#cb35-891" aria-hidden="true" tabindex="-1"></a><span class="kw">&lt;/details&gt;</span></span>
<span id="cb35-892"><a href="#cb35-892" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-893"><a href="#cb35-893" aria-hidden="true" tabindex="-1"></a>:::</span>
<span id="cb35-894"><a href="#cb35-894" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-895"><a href="#cb35-895" aria-hidden="true" tabindex="-1"></a>The problem with the separate data points is the unit.</span>
<span id="cb35-896"><a href="#cb35-896" aria-hidden="true" tabindex="-1"></a>They were measured in mg instead of g and are 3 digits off.</span>
<span id="cb35-897"><a href="#cb35-897" aria-hidden="true" tabindex="-1"></a>This can easily be seen, when adding the regression lines for each data cloud, and two lines in between with the same slope but the intercept being 10 times smaller.</span>
<span id="cb35-898"><a href="#cb35-898" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-899"><a href="#cb35-899" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-902"><a href="#cb35-902" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb35-903"><a href="#cb35-903" aria-hidden="true" tabindex="-1"></a><span class="co">#| label: fig-correlation-lines</span></span>
<span id="cb35-904"><a href="#cb35-904" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-cap: "Correlation between leaf area and dry mass."</span></span>
<span id="cb35-905"><a href="#cb35-905" aria-hidden="true" tabindex="-1"></a><span class="co">#| fig-alt: "A plot showing the correlation between leaf area and dry mass."</span></span>
<span id="cb35-906"><a href="#cb35-906" aria-hidden="true" tabindex="-1"></a><span class="co">#| echo: false</span></span>
<span id="cb35-907"><a href="#cb35-907" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-908"><a href="#cb35-908" aria-hidden="true" tabindex="-1"></a>raw_traits <span class="sc">|&gt;</span></span>
<span id="cb35-909"><a href="#cb35-909" aria-hidden="true" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span>Value) <span class="sc">|&gt;</span> </span>
<span id="cb35-910"><a href="#cb35-910" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_wider</span>(<span class="at">names_from =</span> Trait, <span class="at">values_from =</span> Value_log) <span class="sc">|&gt;</span></span>
<span id="cb35-911"><a href="#cb35-911" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Dry_Mass_g_log, <span class="at">y =</span> Leaf_Area_cm2_log)) <span class="sc">+</span></span>
<span id="cb35-912"><a href="#cb35-912" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb35-913"><a href="#cb35-913" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fl">4.6612</span>, <span class="at">slope =</span> <span class="fl">0.9158</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-914"><a href="#cb35-914" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fl">6.6612</span>, <span class="at">slope =</span> <span class="fl">0.9158</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-915"><a href="#cb35-915" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fl">8.6612</span>, <span class="at">slope =</span> <span class="fl">0.9158</span>, <span class="at">colour =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-916"><a href="#cb35-916" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_abline</span>(<span class="at">intercept =</span> <span class="fl">10.6612</span>, <span class="at">slope =</span> <span class="fl">0.9158</span>, <span class="at">colour =</span> <span class="st">"red"</span>)</span>
<span id="cb35-917"><a href="#cb35-917" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-918"><a href="#cb35-918" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb35-919"><a href="#cb35-919" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-920"><a href="#cb35-920" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb35-921"><a href="#cb35-921" aria-hidden="true" tabindex="-1"></a></span>
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->



</body></html>