<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4 Contents | Writing an R package</title>
<meta name="author" content="Richard J Telford">
<meta name="generator" content="bookdown 0.23 with bs4_book()">
<meta property="og:title" content="4 Contents | Writing an R package">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="4 Contents | Writing an R package">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.10/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.5.1/tabs.js"></script><script src="libs/bs3compat-0.2.5.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><link rel="stylesheet" href="/home/gbsrt/Documents/teaching/biostats-1/css/style-chapters.css">
<meta name="description" content="4.1 Basic workflow Write tests (section 4.2) Write functions (section 4.3) and documentation (section 4.4) Check package (section 4.7) Fix errors goto 3 Test drive with devtools::load_all() Build...">
<meta property="og:description" content="4.1 Basic workflow Write tests (section 4.2) Write functions (section 4.3) and documentation (section 4.4) Check package (section 4.7) Fix errors goto 3 Test drive with devtools::load_all() Build...">
<meta name="twitter:description" content="4.1 Basic workflow Write tests (section 4.2) Write functions (section 4.3) and documentation (section 4.4) Check package (section 4.7) Fix errors goto 3 Test drive with devtools::load_all() Build...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Writing an R package</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Introduction</a></li>
<li><a class="" href="system-setup.html"><span class="header-section-number">2</span> System setup</a></li>
<li><a class="" href="creating-the-package-infrastructure.html"><span class="header-section-number">3</span> Creating the package infrastructure</a></li>
<li><a class="active" href="contents.html"><span class="header-section-number">4</span> Contents</a></li>
<li><a class="" href="more-documentation.html"><span class="header-section-number">5</span> More documentation</a></li>
<li><a class="" href="distributing-your-package.html"><span class="header-section-number">6</span> Distributing your package</a></li>
<li><a class="" href="troubleshooting.html"><span class="header-section-number">7</span> Troubleshooting</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="contents" class="section level1" number="4">
<h1>
<span class="header-section-number">4</span> Contents<a class="anchor" aria-label="anchor" href="#contents"><i class="fas fa-link"></i></a>
</h1>
<div id="basic-workflow" class="section level2" number="4.1">
<h2>
<span class="header-section-number">4.1</span> Basic workflow<a class="anchor" aria-label="anchor" href="#basic-workflow"><i class="fas fa-link"></i></a>
</h2>
<ol style="list-style-type: decimal">
<li>Write tests (section <a href="contents.html#tests">4.2</a>)</li>
<li>Write functions (section <a href="contents.html#functions">4.3</a>) and documentation (section <a href="contents.html#documentation-with-roxygen2">4.4</a>)</li>
<li>Check package (section <a href="contents.html#checking">4.7</a>)</li>
<li>Fix errors goto 3</li>
<li>Test drive with <code><a href="https://devtools.r-lib.org//reference/load_all.html">devtools::load_all()</a></code>
</li>
<li>Build and install (section <a href="contents.html#build-and-install">4.7.1</a>)</li>
</ol>
<p>Because there are usually lots of errors to fix, it is sensible to build the package slowly, testing with Check frequently.</p>
</div>
<div id="tests" class="section level2" number="4.2">
<h2>
<span class="header-section-number">4.2</span> Tests<a class="anchor" aria-label="anchor" href="#tests"><i class="fas fa-link"></i></a>
</h2>
<p>You need to write tests for your package to ensure your functions do what they are supposed.
They protect you against breaking your package when you edit your code.
Tests are run when the package is checked</p>
<p>You can, ideally should, write tests before you write your functions.
We can use the <code>testthat</code> package for the tests.</p>
<p>Set up the testing infrastructure with</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://usethis.r-lib.org/reference/use_testthat.html">use_testthat</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>Now set up a test file for one or more related functions with <code><a href="https://usethis.r-lib.org/reference/use_r.html">use_test()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://usethis.r-lib.org/reference/use_r.html">use_test</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"import"</span><span class="op">)</span></code></pre></div>
<p>This will create and open a file called <code>test-import.R</code> which looks like</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">test_that</span><span class="op">(</span><span class="st">"multiplication works"</span>, <span class="op">{</span>
  <span class="fu">expect_equal</span><span class="op">(</span><span class="fl">2</span> <span class="op">*</span> <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>The first argument of <code>test_that()</code> is a description, second argument is an expression which contains the test.
More complex tests might need some additional set-up code in the expression.
There are several <code>expect_*()</code> functions to test different aspects of the function, including that errors and warnings are thrown as expected.
Each <code>test_that()</code> call can test multiple expectations.
You can have multiple <code>test_that()</code> calls per file.</p>
<p>Look for examples of tests on GitHub if you need inspiration.</p>
<p>Functions are much easier to test the functions do one job.
This is also best practice when writing functions.
For example, if you were writing a package to import, process, and plot logger data, you would make at least three functions to do this, not one function that does everything.</p>
</div>
<div id="functions" class="section level2" number="4.3">
<h2>
<span class="header-section-number">4.3</span> Functions<a class="anchor" aria-label="anchor" href="#functions"><i class="fas fa-link"></i></a>
</h2>
<p>Functions are made with the keyword function, can have one or more arguments separated by commas, and needs assigning to a name.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">arg1</span> <span class="op">=</span> <span class="fl">1</span>, <span class="va">arg2</span><span class="op">)</span><span class="op">{</span>
  <span class="va">arg1</span> <span class="op">*</span> <span class="va">arg2</span>
<span class="op">}</span>

<span class="fu">my_function</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></code></pre></div>
<p>Functions need to be saved in <code>R/</code>.
Related functions can be saved in the same file.</p>
<div id="well-behaved-functions" class="section level3" number="4.3.1">
<h3>
<span class="header-section-number">4.3.1</span> Well behaved functions<a class="anchor" aria-label="anchor" href="#well-behaved-functions"><i class="fas fa-link"></i></a>
</h3>
<p>Try not to alter the state of the users R session.
Don’t include calls to library() or require() in functions (see section <a href="contents.html#importing-and-exporting-functions">4.4.1</a>).
If you need to change the state, then revert it with when the function finishes.
You can do this with <code><a href="https://withr.r-lib.org/reference/defer.html">withr::defer()</a></code>.
This is better behaved than the base R equivalent <code><a href="https://rdrr.io/r/base/on.exit.html">on.exit()</a></code>.
Even if the function throws an error, the state of <code>options</code> will be reverted to its original state.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="va">op</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span>digits <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="co"># set options</span>
  <span class="fu">withr</span><span class="fu">::</span><span class="fu"><a href="https://withr.r-lib.org/reference/defer.html">defer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/options.html">options</a></span><span class="op">(</span><span class="va">op</span><span class="op">)</span><span class="op">)</span> <span class="co">#next line</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
</div>
<div id="data-validation---expect-the-unexpected." class="section level3" number="4.3.2">
<h3>
<span class="header-section-number">4.3.2</span> Data validation - expect the unexpected.<a class="anchor" aria-label="anchor" href="#data-validation---expect-the-unexpected."><i class="fas fa-link"></i></a>
</h3>
<p>If you are going to release your package, you need to try to make it idiot proof.
Assume users will make mistakes with their data input.
Use code to validate that the data are correct, or else throw an error.
<code>if</code> statements and <code><a href="https://rdrr.io/r/base/stop.html">stop()</a></code> are useful here.</p>
</div>
<div id="s3-classes-in-r" class="section level3" number="4.3.3">
<h3>
<span class="header-section-number">4.3.3</span> S3 classes in R<a class="anchor" aria-label="anchor" href="#s3-classes-in-r"><i class="fas fa-link"></i></a>
</h3>
<p>When you use a generic function in R such as <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code>, <code><a href="https://rdrr.io/r/base/print.html">print()</a></code>, <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code> or <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code>, what happens is that the class of the object in determined and dispatched to the appropriate function, which will have the name of the generic followed by the name of the class, separated by a dot.</p>
<p>So a call to <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> with an object of class <code>cca</code> will be dispatched to <code>plot.cca</code>.</p>
<p>You can find out the class of an object with <code><a href="https://rdrr.io/r/base/class.html">class()</a></code></p>
<p>The class of an object can be set with <code><a href="https://rdrr.io/r/base/class.html">class()</a></code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_function</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span><span class="op">{</span>
  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">complex_logic</span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="st">"my_class"</span>
  <span class="va">result</span>
  <span class="op">}</span></code></pre></div>
<p>If the object already has a class and you want to keep it, you need something like</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R">  <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"my_class"</span>, <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">result</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>To make a <code><a href="https://rdrr.io/r/base/print.html">print()</a></code> or <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot()</a></code> method for <code>my_class</code>, we simply make a function called <code>print.my_class</code> or <code>plot.my_class</code>.
The method will be declared automatically when the documentation (<a href="contents.html#documentation-with-roxygen2">4.4</a>) is made.</p>
</div>
<div id="going-further-with-classes" class="section level3 unnumbered facta toc-ignore">
<h3>Going further with classes<a class="anchor" aria-label="anchor" href="#going-further-with-classes"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Make your <a href="https://adv-r.hadley.nz/s3.html#s3-methods">own generics</a>
</li>
<li>Use the more formal <a href="https://adv-r.hadley.nz/oo.html">S4 or R6 class</a> systems</li>
</ul>
</div>
<div id="section" class="section level3" number="4.3.4">
<h3>
<span class="header-section-number">4.3.4</span> …<a class="anchor" aria-label="anchor" href="#section"><i class="fas fa-link"></i></a>
</h3>
<p>Ellipses can be used in two ways when writing functions.</p>
<p>The first is to pass unknown arguments to a second function (e.g., <code>plot.cca()</code>).</p>
<p>If we make a <code>plot.my_class()</code> function we can use the ellipses so we don’t need to specify all the possible arguments in plot.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">plot.my_class</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">obj</span>, <span class="va">...</span><span class="op">)</span><span class="op">{</span>
  <span class="co">#logic to prepare data for plotting</span>
  <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">obj</span><span class="op">$</span><span class="va">x</span>
  <span class="va">y</span> <span class="op">&lt;-</span><span class="va">obj</span><span class="op">$</span><span class="va">y</span>
  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, <span class="va">...</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>Now all of arguments to <code><a href="https://rdrr.io/r/graphics/plot.default.html">plot.default()</a></code> can be used.</p>
<p>The second way to use ellipses is when there are a variable number of arguments.
We can capture the <code>...</code> using <code><a href="https://rdrr.io/r/base/list.html">list()</a></code>, and then process it further.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">dot_to_list</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">dot_to_list</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="st">"c"</span><span class="op">)</span></code></pre></div>
<pre><code>## [[1]]
## [1] 1
## 
## [[2]]
## [1] 2
## 
## [[3]]
## [1] "c"</code></pre>
</div>
<div id="using-dplyr-ggplot2-etc" class="section level3" number="4.3.5">
<h3>
<span class="header-section-number">4.3.5</span> Using <code>dplyr</code>, <code>ggplot2</code> etc<a class="anchor" aria-label="anchor" href="#using-dplyr-ggplot2-etc"><i class="fas fa-link"></i></a>
</h3>
<p>Tidyverse packages such as <code>dplyr</code> and <code>ggplot2</code> which use Non-Standard Evaluation (NSE) are a little challenging to use in functions.</p>
<p>We cannot just do something like this as we get an error</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_select</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">col</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/select.html">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">col</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">my_select</span><span class="op">(</span><span class="va">penguins</span>, col <span class="op">=</span> <span class="va">species</span><span class="op">)</span></code></pre></div>
<pre><code>## Error: object 'species' not found</code></pre>
<p>One solution is to use the curly-curly notation</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#select</span>
<span class="va">my_select2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">col</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/select.html">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">{</span><span class="op">{</span><span class="va">col</span><span class="op">}</span><span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">my_select2</span><span class="op">(</span><span class="va">penguins</span>, col <span class="op">=</span> <span class="va">species</span><span class="op">)</span></code></pre></div>
<pre><code>## select: dropped 7 variables (island, bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g, …)</code></pre>
<pre><code>## # A tibble: 344 × 1
##   species
##   &lt;fct&gt;  
## 1 Adelie 
## 2 Adelie 
## 3 Adelie 
## # … with 341 more rows</code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># filter</span>
<span class="va">my_filter</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">col</span>, <span class="va">`%test%`</span>, <span class="va">value</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/filter.html">filter</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">{</span><span class="op">{</span><span class="va">col</span><span class="op">}</span><span class="op">}</span> <span class="op">%test%</span> <span class="va">value</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">my_filter</span><span class="op">(</span><span class="va">penguins</span>, col <span class="op">=</span> <span class="va">species</span>, `%test%` <span class="op">=</span> <span class="va">`==`</span>, value <span class="op">=</span> <span class="st">"Adelie"</span><span class="op">)</span></code></pre></div>
<pre><code>## filter: removed 192 rows (56%), 152 rows remaining</code></pre>
<pre><code>## # A tibble: 152 × 8
##   species island    bill_length_mm bill_depth_mm flipper_length_…
##   &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;            &lt;int&gt;
## 1 Adelie  Torgersen           39.1          18.7              181
## 2 Adelie  Torgersen           39.5          17.4              186
## 3 Adelie  Torgersen           40.3          18                195
## # … with 149 more rows, and 3 more variables:
## #   body_mass_g &lt;int&gt;, sex &lt;fct&gt;, year &lt;int&gt;</code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#mutate Note the := operator.</span>
<span class="va">my_mutate</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">col1</span>, <span class="va">col2</span>, <span class="va">sum_col</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/mutate.html">mutate</a></span><span class="op">(</span><span class="va">data</span>, <span class="op">{</span><span class="op">{</span><span class="va">sum_col</span><span class="op">}</span><span class="op">}</span> <span class="op">:=</span> <span class="op">{</span><span class="op">{</span><span class="va">col1</span><span class="op">}</span><span class="op">}</span> <span class="op">+</span> <span class="op">{</span><span class="op">{</span><span class="va">col2</span><span class="op">}</span><span class="op">}</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">my_mutate</span><span class="op">(</span><span class="va">penguins</span>, <span class="va">bill_length_mm</span>, <span class="va">bill_depth_mm</span>, sum_col <span class="op">=</span> <span class="va">bill</span><span class="op">)</span></code></pre></div>
<pre><code>## mutate: new variable 'bill' (double) with 198 unique values and 1% NA</code></pre>
<pre><code>## # A tibble: 344 × 9
##   species island    bill_length_mm bill_depth_mm flipper_length_…
##   &lt;fct&gt;   &lt;fct&gt;              &lt;dbl&gt;         &lt;dbl&gt;            &lt;int&gt;
## 1 Adelie  Torgersen           39.1          18.7              181
## 2 Adelie  Torgersen           39.5          17.4              186
## 3 Adelie  Torgersen           40.3          18                195
## # … with 341 more rows, and 4 more variables:
## #   body_mass_g &lt;int&gt;, sex &lt;fct&gt;, year &lt;int&gt;, bill &lt;dbl&gt;</code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#ggplot</span>
<span class="va">my_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">x</span>, <span class="va">y</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">data</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">x</span><span class="op">}</span><span class="op">}</span>, y <span class="op">=</span> <span class="op">{</span><span class="op">{</span><span class="va">y</span><span class="op">}</span><span class="op">}</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">my_plot</span><span class="op">(</span><span class="va">penguins</span>, x <span class="op">=</span> <span class="va">bill_length_mm</span>, y <span class="op">=</span> <span class="va">body_mass_g</span><span class="op">)</span></code></pre></div>
<pre><code>## Warning: Removed 2 rows containing missing values (geom_point).</code></pre>
<div class="inline-figure"><img src="packageWriting-bookdown_files/figure-html/tidyselect-working-1.png" width="672"></div>
<p>Another is to have the arguments as strings and use the <code>.data</code> pronoun from <code>rlang</code> (don’t forget to import <code>rlang</code> (see section <a href="contents.html#importing-and-exporting-functions">4.4.1</a>.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">my_select3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">col</span><span class="op">)</span><span class="op">{</span>
  <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/select.html">select</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">.data</span><span class="op">[[</span><span class="va">col</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu">my_select3</span><span class="op">(</span><span class="va">penguins</span>, col <span class="op">=</span> <span class="st">"species"</span><span class="op">)</span></code></pre></div>
<pre><code>## select: dropped 7 variables (island, bill_length_mm, bill_depth_mm, flipper_length_mm, body_mass_g, …)</code></pre>
<pre><code>## # A tibble: 344 × 1
##   species
##   &lt;fct&gt;  
## 1 Adelie 
## 2 Adelie 
## 3 Adelie 
## # … with 341 more rows</code></pre>
<p>NSE can also be a problem for functions that don’t take column names as arguments.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">process_penguin_type_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span>
  <span class="va">data</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/summarise.html">summarise</a></span><span class="op">(</span>bill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">bill_length_mm</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span> </code></pre></div>
<p>The next function should work, but will generate a note in the checking stage. as the check does not recognise <code>or</code>.</p>
<pre><code>&gt; checking R code for possible problems ... NOTE
  process_penguin_type_data: no visible binding for global variable
    ‘species’
  process_penguin_type_data: no visible binding for global variable
    ‘bill_length_mm’
  Undefined global functions or variables:
    bill_length_mm species</code></pre>
<p>To fix this, either declare these variables as global with this line added to the file (outside the function).</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">utils</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/utils/globalVariables.html">globalVariables</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">'bill_length_mm'</span>, <span class="st">'species'</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Or, perhaps better, use the <code>.data</code> pronoun.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">process_penguin_type_data</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">{</span>
  <span class="va">data</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/group_by.html">group_by</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">species</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://rdrr.io/pkg/tidylog/man/summarise.html">summarise</a></span><span class="op">(</span>bill <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.data</span><span class="op">$</span><span class="va">bill_length_mm</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span> </code></pre></div>
</div>
</div>
<div id="documentation-with-roxygen2" class="section level2" number="4.4">
<h2>
<span class="header-section-number">4.4</span> Documentation with Roxygen2<a class="anchor" aria-label="anchor" href="#documentation-with-roxygen2"><i class="fas fa-link"></i></a>
</h2>
<p>The documentation for the package lives in <code>man/</code> in .Rd files.
The files are written in a LaTeX like language, that is quite hard to get to right.
Fortunately, the <a href="https://roxygen2.r-lib.org/index.html"><code>roxygen2</code> package</a> takes most of the pain away as the format is much simpler. Also, some parts of the documentation are automatically generated by inspecting the code, and it is easier to keep the documentation and code in sync because the are in the same file.</p>
<p>The roxygen2 comments sit above the function, and start with <code>#'</code> to distinguish them from ordinary comments.</p>
<p>The first sentence of the roxygen becomes the title of the help file.
Then we can use roxygen tags for the rest of the documentation.
Roxygen tags all start with an <code><a href="https://rdrr.io/r/base/slotOp.html">@</a></code>.
Once you type this, RStudio gives you suggestions.</p>
<p><code>@description</code> One paragraph description of what the function does.</p>
<p><code>@param</code> argument_name followed by a description of the argument
All parameters must be documented.</p>
<p><code>@details</code> All the gory details. Possibly several paragraphs (separate with a blank line).</p>
<p><code>@return</code> A description of the object returned by the function (if any)</p>
<p><code>@examples</code>
Working examples which will be run when the package is tested.
Examples should run relatively quickly or they become tedious.
They need to use <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> to load any packages needed other than the package being developed.
Any packages loaded by <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> need to be declared in the DESCRIPTION file (see section <a href="contents.html#importing-and-exporting-functions">4.4.1</a>)</p>
<p>You can use <a href="https://roxygen2.r-lib.org/articles/markdown.html">markdown</a> to enhance the documentation, including links etc.</p>
<div id="importing-and-exporting-functions" class="section level3" number="4.4.1">
<h3>
<span class="header-section-number">4.4.1</span> Importing and exporting functions<a class="anchor" aria-label="anchor" href="#importing-and-exporting-functions"><i class="fas fa-link"></i></a>
</h3>
<p>The roxygen comments are also where you import functions from other packages and mark your functions for export.
This information will be written into the NAMESPACE file so you don’t have to (see the <a href="https://r-pkgs.org/namespace.html#namespace">R package book</a> for more information about this file).</p>
<p>If you want to use a function from any other package (except <code>base</code>) you need to add the dependency to the package to the DESCRIPTION file.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://usethis.r-lib.org/reference/use_package.html">use_package</a></span><span class="op">(</span><span class="st">"dplyr"</span><span class="op">)</span>
<span class="co">#use_dev_package("packageFromGithub")</span></code></pre></div>
<p>You can now use a function from <code>dplyr</code> with <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate</a></code>.
This gets messy if you need to use lots of functions from a package.
Then it is better to import them.
We could use</p>
<pre><code>#' @import dplyr</code></pre>
<p>to import all functions in the package, or</p>
<pre><code>#' @importFrom dplyr %&gt;%</code></pre>
<p>if we want to just import specific functions.
This is safer as it minimises the risk of conflicts.</p>
<p>Forgetting to import functions or to declare the dependencies in the DESCRIPTION file are very common problems when checking the package, but the message is informative (section <a href="troubleshooting.html#troubleshooting">7</a>).</p>
<p>Export any of your functions that you want users to have access to by adding <code>@export</code> to the roxygen comments.</p>
</div>
<div id="generate-the-.rd-files" class="section level3" number="4.4.2">
<h3>
<span class="header-section-number">4.4.2</span> Generate the .Rd files<a class="anchor" aria-label="anchor" href="#generate-the-.rd-files"><i class="fas fa-link"></i></a>
</h3>
<p>Convert the roxygen comments to .Rd files with</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/document.html">document</a></span><span class="op">(</span><span class="op">)</span> </code></pre></div>
<p>View the compiled help files by running</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>which simulates loading the package without having to install it properly.
Then you can use <code><a href="https://rdrr.io/r/utils/Question.html">?</a></code> as normal to get the help (links won’t work)</p>
</div>
</div>
<div id="data" class="section level2" number="4.5">
<h2>
<span class="header-section-number">4.5</span> Data<a class="anchor" aria-label="anchor" href="#data"><i class="fas fa-link"></i></a>
</h2>
<p>Many packages include data, either because they are needed for examples, or because the aim of the package is to distribute a dataset (probably with some functions to access it).</p>
<p>Data are stored in <code>data/</code> as <code>.rda</code> files and can be loaded into R with the <code><a href="https://rdrr.io/r/utils/data.html">data()</a></code> function.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"penguins"</span>, package <span class="op">=</span> <span class="st">"palmerpenguins"</span><span class="op">)</span></code></pre></div>
<p>The best way to add <code>.rda</code> files is to use the function <code><a href="https://usethis.r-lib.org/reference/use_data.html">use_data_raw()</a></code> with the name of the dataset you want create.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://usethis.r-lib.org/reference/use_data.html">use_data_raw</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"dataset1"</span><span class="op">)</span></code></pre></div>
<p>This will create <code>data_raw/</code> and add a file called <code>dataset1.R</code> that looks like this.</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">## code to prepare `dataset1` dataset goes here</span>

<span class="fu">usethis</span><span class="fu">::</span><span class="fu"><a href="https://usethis.r-lib.org/reference/use_data.html">use_data</a></span><span class="op">(</span><span class="va">dataset1</span>, overwrite <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p>Add the code needed to reproducibly create <code>dataset1</code>, perhaps importing and processing data files that you have copied into <code>data-raw/</code>.</p>
<p>When you run the entire script, the code will create <code>dataset1.rda</code> in <code>data/</code>.</p>
<div id="documenting-data" class="section level3" number="4.5.1">
<h3>
<span class="header-section-number">4.5.1</span> Documenting data<a class="anchor" aria-label="anchor" href="#documenting-data"><i class="fas fa-link"></i></a>
</h3>
<p>Data in <code>data/</code> need to be documented.
Write the documentation for the data using roxygen2 and save it in <code>R/</code>.
I usually call this file <code>data.R</code> and document all the datasets in it.</p>
<p>In my traitstrap package, one of the data objects is called trait.
Here is the entry from <code>R/data.R</code>:</p>
<pre><code>#' Trait data
#'
#' A dataset containing plant traits in control plots on Svalbard from PFCT4
#' TraitTrain course.
#'
#' @format A data frame with 53940 rows and 10 variables:
#' \describe{
#'   \item{Taxon}{species name}
#'   \item{Site}{site name}
#'   \item{PlotID}{plot name}
#'   \item{Trait}{trait name with unit}
#'   \item{Value}{trait value}
#' }
#' @source \url{http://https://www.uib.no/en/rg/EECRG/114808/plant-functional-traits-course-4}
"trait"</code></pre>
<p>The first line gives the title followed by the desciption.
The @format field lets you describe the data.
The last line has the object name in quotes (note no #’ first).</p>
</div>
</div>
<div id="adding-other-files" class="section level2" number="4.6">
<h2>
<span class="header-section-number">4.6</span> Adding other files<a class="anchor" aria-label="anchor" href="#adding-other-files"><i class="fas fa-link"></i></a>
</h2>
<p>R gets upset if there are files where they are not supposed to be in the R package.
You cannot put extra files into the package root directory.
The solution is to put extra files into subdirectories in <code>inst/</code>.</p>
<p>If you want to include raw data files because your package has functions to process them, they can go in <code>inst/extdata/</code>.</p>
<p>When the package is compiled, <code>inst/</code> will be removed and <code>extdata/</code> will be put into the package root directory.
The path to the file can the be accessed with <code><a href="https://rdrr.io/r/base/system.file.html">system.file()</a></code>.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, package <span class="op">=</span> <span class="st">"readr"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></code></pre></div>
<p>Tutorials and other resources can also be put into suitable directories in <code>inst/</code>.</p>
</div>
<div id="checking" class="section level2" number="4.7">
<h2>
<span class="header-section-number">4.7</span> Checking<a class="anchor" aria-label="anchor" href="#checking"><i class="fas fa-link"></i></a>
</h2>
<p>Now we are ready to check the package compiles correctly.
The check function is slow (it checks many aspects of the package), so before running it, run some functions that check different aspects of the package.</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># build the documentation</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/document.html">document</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># check the examples work</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/run_examples.html">run_examples</a></span><span class="op">(</span><span class="op">)</span>

<span class="co"># check the tests work</span>
<span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/test.html">test</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>After fixing any problems, check the entire package either with the <code>Check</code> button in the Build tab (in the same panel as the Environment tab), or with <code><a href="https://devtools.r-lib.org//reference/check.html">devtools::check()</a></code>.
They do exactly the same work, but the Check button leaves the console available.</p>
<p>Check is very thorough.
It will almost certainly report errors, warnings or notes the first times you run it.
Identify the problems, fix them and run check again.</p>
<p>Now use</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://devtools.r-lib.org//reference/load_all.html">load_all</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>and give your functions a test drive.</p>
<div id="build-and-install" class="section level3" number="4.7.1">
<h3>
<span class="header-section-number">4.7.1</span> Build and install<a class="anchor" aria-label="anchor" href="#build-and-install"><i class="fas fa-link"></i></a>
</h3>
<p>When you are happy with your package, use the “Install and Restart” button in the build tab to install your package.
Now you can load it with <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> as you would any other package.</p>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="creating-the-package-infrastructure.html"><span class="header-section-number">3</span> Creating the package infrastructure</a></div>
<div class="next"><a href="more-documentation.html"><span class="header-section-number">5</span> More documentation</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#contents"><span class="header-section-number">4</span> Contents</a></li>
<li><a class="nav-link" href="#basic-workflow"><span class="header-section-number">4.1</span> Basic workflow</a></li>
<li><a class="nav-link" href="#tests"><span class="header-section-number">4.2</span> Tests</a></li>
<li>
<a class="nav-link" href="#functions"><span class="header-section-number">4.3</span> Functions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#well-behaved-functions"><span class="header-section-number">4.3.1</span> Well behaved functions</a></li>
<li><a class="nav-link" href="#data-validation---expect-the-unexpected."><span class="header-section-number">4.3.2</span> Data validation - expect the unexpected.</a></li>
<li><a class="nav-link" href="#s3-classes-in-r"><span class="header-section-number">4.3.3</span> S3 classes in R</a></li>
<li><a class="nav-link" href="#going-further-with-classes">Going further with classes</a></li>
<li><a class="nav-link" href="#section"><span class="header-section-number">4.3.4</span> …</a></li>
<li><a class="nav-link" href="#using-dplyr-ggplot2-etc"><span class="header-section-number">4.3.5</span> Using dplyr, ggplot2 etc</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#documentation-with-roxygen2"><span class="header-section-number">4.4</span> Documentation with Roxygen2</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#importing-and-exporting-functions"><span class="header-section-number">4.4.1</span> Importing and exporting functions</a></li>
<li><a class="nav-link" href="#generate-the-.rd-files"><span class="header-section-number">4.4.2</span> Generate the .Rd files</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#data"><span class="header-section-number">4.5</span> Data</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#documenting-data"><span class="header-section-number">4.5.1</span> Documenting data</a></li></ul>
</li>
<li><a class="nav-link" href="#adding-other-files"><span class="header-section-number">4.6</span> Adding other files</a></li>
<li>
<a class="nav-link" href="#checking"><span class="header-section-number">4.7</span> Checking</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#build-and-install"><span class="header-section-number">4.7.1</span> Build and install</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Writing an R package</strong>" was written by Richard J Telford. It was last built on 2021-08-25.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer>
</body>
</html>
